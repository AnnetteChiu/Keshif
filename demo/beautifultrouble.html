<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<title>Beautiful Trouble</title><meta charset="utf-8">
        <script type="text/javascript" src="../js/jquery-1.11.1.min.js"></script>
        <script type="text/javascript" src="../js/d3.v3.min.js" charset="utf-8"></script>
        <script type="text/javascript" src="../keshif.js" charset="utf-8"></script>
        <link rel="stylesheet" href="../keshif.css"/ type="text/css">
        <link rel="stylesheet" href="../font-awesome/css/font-awesome.min.css">

        <script type="text/javascript" src="./js/demo.js" charset="utf-8"></script>
        <link rel="stylesheet" href="./css/style.css"/ type="text/css">

        <script type="text/javascript">

function resetSize(){
//    $('#chart_div').height($(window).height()-10);
    $('#chart_div').height(700);
    $('#chart_div').width (1000);
}

function loadImage(d){
    if(d.target.className==="item_details_off") return;
    var kshfItem = d.currentTarget.__data__;
    var d3Item = d3.select(kshfItem.listItem);
    d3Item.select(".postImg").attr("src",kshfItem.data[postCols['Img']]);
};
function getType(d){
    switch(d.data.type){
        case 0: return "Tactics";
        case 1: return "Principles";
        case 2: return "Theories";
        case 3: return "Case Studies";
        case 4: return "Practitioners";
    }
    return "-";
};

$(document).ready( function(){
    resetSize();
    // set resize callback
    $(window).resize(function() {
        resetSize();
        browser.updateLayout();
    });

	browser = new kshf.Browser({
        domID : "#chart_div",
        categoryTextWidth: 270,
        itemName: "Posts",
        source : {
            url: "http://explore.beautifultrouble.org/app/data.json",
            callback: function(browser){
                browser.primaryTableName = "Posts";

                kshf.dt.Posts = [];
                kshf.dt_id.Posts = {};

                kshf.dt.Types = [];
                kshf.dt_id.Types = {};

                $.ajax( {
                    //      To use dynamic data loaded from maryland.gov, use the following link instead
                    //        url: "https://data.maryland.gov/api/views/3rgd-zjxx/rows.json?accessType=DOWNLOAD",
                    url: "./data/beautifultrouble.json",
                    dataType: "json",
                    success: function(data){

                        data.forEach(function(item){
                            var kshfItem = new kshf.Item(item,"id");
                            kshf.dt.Posts.push(kshfItem);
                            kshf.dt_id.Posts[kshfItem.id()] = kshfItem;
                        });

                        var types = ["Tactics","Principles","Theories","Case Studies","Practitioners"];
                        types.forEach(function(t,i){
                            var kshfItem = new kshf.Item([i,t],0);
                            kshf.dt.Types.push(kshfItem);
                            kshf.dt_id.Types[kshfItem.id()] = kshfItem;
                        })

                        if(browser){
                            browser.items = kshf.dt.Posts;
                            browser.itemsSelectedCt = browser.items.length;

                            // finish loading....
                            d3.select(".kshf.layout_infobox div.status_text span").text("Creating browser");
                            d3.select(".kshf.layout_infobox div.status_text div").text("");
                            window.setTimeout(function() { browser.loadCharts(); }, 50);
                        }
                    }
                });
            }
        },
        facets: [
            {   facetTitle: "Type",
                catItemMap: function(d){ return d.data.type; },
                catTableName: "Types",
                domStyle: function(d){ 
                    return "itemType_"+d.data[0]; // number id
                },
                catLabelText: function(d){
                    return d.data[1]+" <span class='typeImg'></span>";
                }
            },{
                facetTitle: "# of Related Posts",
                catItemMap: function(d){
                    return d.data.links.length;
                },
            },{
                facetTitle: "Related To",
                catItemMap: function(d){
                    return d.data.links;
                },
                domStyle: function(d){ 
                    return "itemType_"+d.data.type; // number id
                },
                catLabelText: function(d){
                    return d.data.title+" <span class='typeImg'></span>";
                },
                // Using the main table name, this will enable linking through items
                catTableName: "Posts"
            }
        ],
        itemDisplay: {
            sortColWidth: 80,
            sortingOpts : [
                { name:'# Related',
                    value: function(d){ return d.data.links.length}},
/*                { name:'Type', 
                    value: function(d){ return d.data.type;}, 
                    label: function(d){ return getType(d); }},*/
//                { name:'id' },
            ],
            showRank: true,
            autoExpandMore: true,
            domStyle: function(d){ return "itemType_"+d.data.type},
            detailsToggle : "One",
            detailsDefault : false,
            textSearch : "Title and text",
            textSearchFunc: function(d){ return d.data.title + " " + d.data.text;},
            contentFunc : function(d) {
                var str="";

                str +="<span class='typeImg'></span> "+d.data.title +" <a target='_blank' href='"+d.data.url+"' class='fa fa-external-link'></a></div>";;

                // add text
                str+="<span class=\"item_details\">";
                    str+="<img class='itemImg' src=''>";
                str+=d.data.text+"</span>";
                
                return str;
            },
            detailCb: function(d){
                if(d.data.image ===undefined) return;
                var d3Item = d3.select(d.resultDOM);
                d3Item.select(".itemImg").attr("src",d.data.image);
            }
        }
    });
});
        </script>
        <style>
            .listItem{ padding-bottom: 4px; }
            .listItem a{
                color:gray;
                text-decoration: none;
            }
            .listItem .item_details{
                font-weight: 300;
            }
            .itemImg{
                width: 200px;
                float: right;
            }
            .listItem a:hover{
                color:orangered;
                font-weight: 700;
                text-decoration: none;
            }
            .typeImg{
                width:17px;
                height:17px;
                display: inline-block;
                background-size: 100% auto;
                border-radius: 10px;
            }
            .attrib .typeImg{
                width:13px;
                height:13px;
                margin-top: 1px;
                margin-left: 2px;
                float: right;
            }
            .itemType_0 .typeImg{
                background-color: #e7932e;
                background-image: url('img/bt_tactic.png');
            }
            .itemType_1 .typeImg{
                background-color: #12A3D9;
                background-image: url('img/bt_principle.png');
            }
            .itemType_2 .typeImg{
                background-color: #b50035;
                background-image: url('img/bt_theory.png');
            }
            .itemType_3 .typeImg{
                background-color: #7eb84f;
                background-image: url('img/bt_case.png');
            }
            .itemType_4 .typeImg{
                background-color: #5F41A3;
                background-image: url('img/bt_practitioner.png');
            }/*
            .itemType_0{
                color: #e7932e;
            }
            .itemType_1{
                color: #12A3D9;
            }
            .itemType_2{
                color: #b50035;
            }
            .itemType_3{
                color: #7eb84f;
            }
            .itemType_4{
                color: #5F41A3;
            }*/
/*            .kshf .kshfChart > .wrapper span.bar{
                background-color: #A6A6A6;
            }*/
            span.mainTextSearch input{
                width: 200px;
            }
            .filter_item .typeImg{
                display: none;
            }
        </style>
    </head>
    <body>
        <div class="contents"><div id="chart_div"></div></div>
    </body>
</html>