<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<title>Summer Outdoor Movies in DC area</title>
        <script type="text/javascript" src="https://www.google.com/jsapi"></script>
        <script type="text/javascript" src="../jquery/jquery-1.9.1.min.js"></script>
        <script type="text/javascript" src="../d3.v3/d3.v3.js" charset="utf-8"></script>
        <script type="text/javascript" src="../keshif.js" charset="utf-8"></script>
        <link rel="stylesheet" href="../keshif.css"/ type="text/css">

        <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Josefin+Slab">

        <script type="text/javascript" src="./js/moment.min.js" charset="utf-8"></script>
        <link rel="stylesheet" href="./css/style.css"/ type="text/css">

        <script type="text/javascript">

// https://software.intel.com/en-us/blogs/2012/11/25/calculating-geographic-distances-in-location-aware-apps
function distanceKilometersGreatCircle (lat1, long1, lat2, long2)
{
    var degToRad= Math.PI / 180;
    var phi1= lat1 * degToRad;
    var phi2= lat2 * degToRad;
    var lam1= long1 * degToRad;
    var lam2= long2 * degToRad;

    return  6371.01 * Math.acos( Math.sin(phi1) * Math.sin(phi2) + Math.cos(phi1) * Math.cos(phi2) * Math.cos(lam2 - lam1) );
}

function loadMovieData(d){
    if(d.target.className==="item_details_off") return;
    var kshfItem = d.currentTarget.__data__;
    if(kshfItem===undefined)
        kshfItem = d.currentTarget.parentNode.__data__;
    if(kshfItem.listItem.getAttribute('details')==="false")
        browser.showListItemDetails(kshfItem);
    if(kshfItem.dataLoaded===true) return;
    loadMovieData_Name(kshfItem);
};

function loadMovieData_Name(kshfItem){
    $.ajax( {
        url: "http://www.omdbapi.com/?t="+kshfItem.data[2],
        dataType: "json",
        success: function(data){
            if(data.Error) {
                console.log("Error loading movie: "+kshfItem.data[2])
                return;
            }
            var d3Item = d3.select(kshfItem.listItem);
            d3Item.select(".moviePoster").attr("src","./img/posters/"+data.imdbID+".jpg");
            d3Item.select(".movieInfo").style("display","block");
            d3Item.select(".Year .value").text(data.Year);
            d3Item.select(".Rated .value").text(data.Rated);
            d3Item.select(".Genre .value").text(data.Genre);
            d3Item.select(".Plot .value").text(data.Plot);
            d3Item.select(".Awards .value").text(data.Awards);
            d3Item.select(".imdbRating .value").text(data.imdbRating);
            d3Item.selectAll("a:not(.location)").attr("href","http://www.imdb.com/title/"+data.imdbID);
            kshfItem.dataLoaded = true;
            console.log(kshfItem.data[2]+", "+data.imdbID+", "+data.Poster);
        }
    });
};

// batch load script
var i=0;
function loadOneMoreMovie(){
    if(i===kshf.dt.Screening.length) return;
    loadMovieData_Name(kshf.dt.Screening[i]);
    i++;
    setTimeout(loadOneMoreMovie, 200);
};

var myLoc=null;
var updateLocationSorting = function(){
    if(myLoc===undefined) return;
    if(browser===undefined) return;
    var me = browser.charts[1];
    if(me===undefined) return;
    me.sortingOpt_Active = me.options.sortingOpts[1];
    me.sortDelay = 0;
    browser.charts[1].divRoot.select(".optionSelect")[0][0].options[1].selected = true;
    me.updateSorting.call(me);
};

function loadChart() {
    if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(function(position) {
            myLoc = position.coords;
            updateLocationSorting();
        });
    }

    // subtracting because movies are considered to start at midnight, and I want to see the movies playing today first.
    var m_now = moment().subtract('days',1);

    var m_thisweek = moment().add('days',7);
    var m_nextweek = moment().add('days',14);

    browser = new kshf.Browser({
        chartTitle: "Summer Outdoor Movies in DC area",
        domID : "#chart_div",
        dirRoot: "../",
        categoryTextWidth: 230,
        itemName: "Outdoor Movie Screenings in DC area",
        source : {
            gdocId : '1WQZX6-pkafMQmJqY8Wgx3O6eKwY5VRmLaN9zSlRJLt8',
            sheets : [ {name:"Screening"}, {name:"Series"} ]
        },
        charts : [
            {
                facetTitle: "State",
                removeInactiveAttrib: false,
                catItemMap: function(d){ 
                    var series = kshf.dt_id.Series[d.data[0]];
                    return series.data[3];
                },
                timeTitle: "Screenings in Next 15 Days",
                timeItemMap : function(d){ 
                    return d.data[1];
                },
            },{
                facetTitle: "Series",
                catTableName: "Series",
                sortingOpts : [
                    {   name: "# of Movies"},
                    {   name: "Distance",  
                        func: function(a,b){
                            // lat-long: 10-11
                            if(myLoc===null) {
                                return kshf.sortFunc_ActiveCount_TotalCount(a,b);
                            }
                            var dist_a = distanceKilometersGreatCircle(
                                myLoc.latitude,myLoc.longitude,a.data[10],a.data[11]);
                            var dist_b = distanceKilometersGreatCircle(
                                myLoc.latitude,myLoc.longitude,b.data[10],b.data[11]);
                            return dist_a - dist_b;
                        }
                    }
                ]
            },{
                facetTitle: "Movie"
            },{
                facetTitle: "Day Of Week",
                catItemMap: function(d){
                    return (moment(d.data[1]).days()+6)%7; 
                },
                sortingOpts : [
                    { func: kshf.sortFunc_Column_Int_Decr, no_resort: true },
                ],
                catLabelText: function(d){
                    switch(d.data[1]){
                        case 0: return "Monday";
                        case 1: return "Tuesday";
                        case 2: return "Wednesday";
                        case 3: return "Thursday";
                        case 4: return "Friday";
                        case 5: return "Saturday";
                        case 6: return "Sunday";
                    }
                }
            }
        ],
        readyCb: function(){
            $(".itemtoggledetails .item_details_on").click(loadMovieData);
            $(".listItem")
                .click(loadMovieData)
                ;

            if(myLoc)
            updateLocationSorting();
        },
        list: {
            sortColWidth: 90,
            sortingOpts : [ {
                name: 'Date',
                func: function(a,b){
                    // a and b are date objects
                    var a_m = moment(a);
                    var b_m = moment(b);
                    var a_isBeforeNow = a_m.isBefore(m_now);
                    var b_isBeforeNow = b_m.isBefore(m_now);
                    if(a_isBeforeNow && !b_isBeforeNow) return -1;
                    if(b_isBeforeNow && !a_isBeforeNow) return 1;
                    return b.getTime() - a.getTime();
                    return a_m.isBefore(b_m);
                },
                inverse: true,
                label: function(d){ 
                    return moment(d.data[1]).format('MMM Do, ddd');
                }
            } ],
            detailsToggle : "One",
            detailsDefault : false,
            contentFunc : function(d) {
                var series = kshf.dt_id.Series[d.data[0]];
                var str="";
                str+="<span class=\"item_details\">";
                str+="<a target='_blank'><img class='moviePoster' src=''></a>"
                str+="</span>"; // item_details

                str+="<span class='movieName'>"+d.data[2]+"</span>";
                str+="<span class=\"item_details\">";

                str+=
                    "<span class='header'>Screening Series</span>: <a target=\"_blank\" class='location' href=\""+series.data[6]+"\">"+
                    series.data[1]+"</a></br>"+
                    "<span class='header'>Location</span>: <b>"+series.data[4]+"</b> - "+ series.data[3]+
                    "<span class='movieInfo' style='display:none;'>"+
                    "<span class='Year'><span class='header'>Year</span>: <span class='value'></span></span></br>"+
                    "<span class='Rated'><span class='header'>Rated</span>: <span class='value'></span></span></br>"+
                    "<span class='Genre'><span class='header'>Genre</span>: <span class='value'></span></span></br>"+
                    "<span class='Plot'><span class='header'>Plot</span>: <span class='value'></span></span></br>"+
                    "<span class='Awards'><span class='header'>Awards</span>: <span class='value'></span></span></br>"+
                    "<span class='imdbRating'><span class='header'>IMDB Rating</span>: <span class='value'></span>"+
                        " - <a target='_blank'>Page</a></span></br>"+
                    "</span>" // movieInfo
                    ;

                str+="</span>"; // item_details
                return str;
            }
        }
    });
}
$(document).ready(loadChart);
</script>
    <style type="text/css" media="screen">
/*        .settingButton { display: none !important;} */
        .listItem{padding: 4px 0px 4px 0px !important;}
        .listItem a{
            color: rgb(95, 62, 21);
        }
        .moviePoster{ 
            float:right; width:120px;

            padding:4px;
            border:solid;
            border-color: #dddddd #aaaaaa #aaaaaa #dddddd;
            border-width: 1px 2px 2px 1px;
            background-color:white;
        }
        .moviePoster:hover{ 
            background-color:rgb(240, 232, 194);
            border-color: #aaaaaa #888888 #888888 #aaaaaa;
        }
        .movieName{
            font-family: Josefin Slab;
            font-size: 1.3em;
            font-weight: 700;
        }
        .listItem[details=false]{
            cursor: pointer !important;
        }
        .listItem[details=true] .movieName{
            pointer-events: none;
        }
        .listItem[details=false]:hover .movieName{
            text-decoration: underline;
            color:rgb(151, 64, 43);
        }
        .listsortcolumn{
            font-weight: 300 !important;
            text-align: right !important;
            padding-right: 5px !important;
        }
        .item_details .header{
            font-weight: 300;
        }
        .movieInfo{
            border-top: dotted 2px gray;
            font-size: 0.9em;
        }
        #chart_div{
            width:1000px;
            height: 600px;
        }
    </style>
	</head>
	<body><div id="chart_div"></div></body>
</html>