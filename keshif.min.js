function Tipsy(t,i){this.jq_element=$(t),this.options=$.extend({},this.defaults,i)}"undefined"!=typeof google&&google.load("visualization","1",{packages:[]}),"function"!=typeof sendLog&&(sendLog=null);var kshf={queryURL_base:"https://docs.google.com/spreadsheet/tq?key=",surrogateCtor:function(){},extendClass:function(t,i){this.surrogateCtor.prototype=t.prototype,i.prototype=new this.surrogateCtor,i.prototype.constructor=i},num_of_charts:0,maxVisibleItems_default:50,dt:{},dt_id:{},dt_ColNames:{},dt_ColNames_Arr:{},createColumnNames:function(t){this.dt_ColNames[t]={},this.dt_ColNames_Arr[t]=[]},insertColumnName:function(t,i,e){this.dt_ColNames[t][i]=e,this.dt_ColNames_Arr[t][e]=i},LOG:{CONFIG:1,FILTER_ADD:10,FILTER_CLEAR:11,FILTER_CLEAR_ALL:12,FILTER_ATTR_ADD_AND:13,FILTER_ATTR_ADD_OR:14,FILTER_ATTR_ADD_ONE:15,FILTER_ATTR_ADD_OR_ALL:16,FILTER_ATTR_ADD_NOT:17,FILTER_ATTR_EXACT:18,FILTER_ATTR_UNSELECT:19,FILTER_TEXTSEARCH:20,FILTER_INTRVL_HANDLE:21,FILTER_INTRVL_BIN:22,FILTER_CLEAR_X:23,FILTER_CLEAR_CRUMB:24,FILTER_PREVIEW:25,FACET_COLLAPSE:40,FACET_SHOW:41,FACET_SORT:42,FACET_SCROLL_TOP:43,FACET_SCROLL_MORE:44,LIST_SORT:50,LIST_SCROLL_TOP:51,LIST_SHOWMORE:52,ITEM_DETAIL_ON:60,ITEM_DETAIL_OFF:61,DATASOURCE:70,INFOBOX:71,CLOSEPAGE:72,BARCHARTWIDTH:73,RESIZE:74}};kshf.Util={dif_itemCount_Active:function(t,i){return i.itemCount_Active-t.itemCount_Active},sortFunc_ActiveCount_TotalCount:function(t,i){var e=kshf.Util.dif_itemCount_Active(t,i);return 0===e?i.items.length-t.items.length:e},sortFunc_Column_Int_Incr:function(t,i){return t.data[1]-i.data[1]},sortFunc_Column_Int_Decr:function(t,i){return i.data[1]-t.data[1]},sortFunc_Column_ParseInt_Incr:function(t,i){return parseFloat(t.data[1],10)-parseFloat(i.data[1],10)},sortFunc_Column_ParseInt_Decr:function(t,i){return parseFloat(i.data[1],10)-parseFloat(t.data[1],10)},sortFunc_String_Decr:function(t,i){return i.data[1].localeCompare(t.data[1])},sortFunc_String_Incr:function(t,i){return i.data[1].localeCompare(t.data[1])},sortFunc_Time_Last:function(t,i){return void 0!==t.xMax_Dyn&&void 0!==i.xMax_Dyn?i.xMax_Dyn-t.xMax_Dyn:void 0===t.xMax_Dyn&&void 0===i.xMax_Dyn?i.xMax-t.xMax:void 0===i.xMax_Dyn?-1:1},sortFunc_Time_First:function(t,i){return void 0!==t.xMax_Dyn&&void 0!==i.xMax_Dyn?t.xMin_Dyn-i.xMin_Dyn:void 0===t.xMax_Dyn&&void 0===i.xMax_Dyn?t.xMin-i.xMin:void 0===i.xMin_Dyn?-1:1},sortFunc_List_String:function(t,i){return t.localeCompare(i)},sortFunc_List_Date:function(t,i){return null===t?-1:null===i?1:t.getTime()-i.getTime()},sortFunc_List_Number:function(t,i){return i-t},cellToArray:function(t,i,e,s){void 0===e&&(e=/\b\s+/);var a;t.forEach(function(t){t=t.data,i.forEach(function(i){var r=t[i];if(null!==r&&"number"!=typeof r){var n=r.split(e);for(r=[],a=0;a<n.length;a++)n[a]=n[a].trim(),""!==n[a]&&r.push(n[a]);if(s!==!1)for(a=0;a<r.length;a++)r[a]=parseInt(r[a],10);t[i]=r}})})},unescapeCommas:function(t){var i,e=!1,s=[];return t.forEach(function(t){if(e){if(i+=","+t,'"'!==t[t.length-1])return;e=!1}else{if('"'===t[0])return e=!0,i=t.slice(1,t.length-1),void 0;i=t}var a=+i;isNaN(a)||""===i||(i=a),s.push(i)}),s},formatForItemCount:function(t){if(1e3>t)return t;if(1e6>t){var i=t/1e3;return 10>i?Math.floor(t/100)/10+"k":Math.floor(i)+"k"}return 1e9>t?Math.floor(t/1e6)+"m":t},nearestYear:function(t){var i=new Date(Date.UTC(t.getUTCFullYear(),0,1));return t.getUTCMonth()>6&&i.setUTCFullYear(i.getUTCFullYear()+1),i},nearestMonth:function(t){var i=new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),1));return t.getUTCDate()>15&&i.setUTCMonth(i.getUTCMonth()+1),i},nearestDay:function(t){var i=new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate()));return t.getUTCHours()>12&&i.setUTCDate(i.getUTCDate()+1),i},nearestHour:function(){},nearestMinute:function(){},clearArray:function(t){for(;t.length>0;)t.pop()},ignoreScrollEvents:!1,scrollToPos_do:function(t,i){kshf.Util.ignoreScrollEvents=!0;var e=null,s=t.scrollTop,a=d3.ease("cubic-in-out"),r=500,n=function(o){var h;null===e&&(e=o),h=(o-e)/r;var l=a(h);t.scrollTop=(1-l)*s+l*i,t.scrollTop!==i?window.requestAnimationFrame(n):kshf.Util.ignoreScrollEvents=!1};window.requestAnimationFrame(n)},toProperCase:function(t){return t.toLowerCase().replace(/\b[a-z]/g,function(t){return t.toUpperCase()})},setTransform:function(t,i){t.style.webkitTransform=i,t.style.MozTransform=i,t.style.msTransform=i,t.style.OTransform=i,t.style.transform=i},insertHeader:function(){var t=this;this.dom.headerGroup=this.divRoot.append("div").attr("class","headerGroup"),this.dom.headerGroup.append("div").attr("class","border_line"),this.dom.headerGroup.append("span").attr("class","header_label_arrow").each(function(){this.tipsy=new Tipsy(this,{gravity:"s",title:function(){return t.collapsed?"Expand facet":"Collapse facet"}})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}).on("click",function(){this.tipsy.hide(),t.collapseFacet(!t.collapsed)}).append("span").attr("class","fa fa-chevron-down");var i=this.dom.headerGroup.append("span");i.append("span").attr("class","chartFilterButtonParent").append("div").attr("class","chartClearFilterButton rowFilter alone").each(function(){this.tipsy=new Tipsy(this,{gravity:"n",title:function(){return"<span class='action'>Remove</span> filter"}})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}).on("click",function(){this.tipsy.hide(),t.facetFilter.clearFilter(!0),sendLog&&sendLog(kshf.LOG.FILTER_CLEAR_X,{id:t.facetFilter.id})}).append("span").attr("class","fa fa-times");var e=this.options.facetTitle;this.parentFacet&&this.parentFacet.hasAttribs()&&(e=e+" <i class='fa fa-chevron-right'></i> "+this.parentFacet.options.facetTitle),i.append("span").attr("class","header_label").html(e).on("click",function(){t.collapsed&&t.collapseFacet(!1)});var s=this.dom.headerGroup.append("span").attr("class","facetIcons");s.append("span").attr("class","hasMultiMappings fa fa-share-alt").each(function(){this.tipsy=new Tipsy(this,{gravity:"ne",title:function(){return"Multiple "+t.options.facetTitle+"s possible"}})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}),this.isLinked?s.append("span").attr("class","isLinkedMark fa fa-check-square-o"):this.parentFacet&&this.parentFacet.hasAttribs()&&s.append("span").attr("class","isLinkedMark fa fa-level-up"),this.options.description&&s.append("span").attr("class","facetDescription fa fa-info-circle").each(function(){this.tipsy=new Tipsy(this,{gravity:"ne",title:function(){return t.options.description}})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}),this.dom.headerGroup.append("div").attr("class","border_line")}},Tipsy.prototype={defaults:{className:null,delayOut:0,fade:!0,fallback:"",gravity:"n",offset:0,offset_x:0,offset_y:0,opacity:.9},show:function(){var t=function(t,i){return"function"==typeof t?t.call(i):t},i=this.getTitle();if(i){var e=this.tip();e.find(".tipsy-inner").html(i),e[0].className="tipsy",e.remove().css({top:0,left:0,visibility:"hidden",display:"block"}).prependTo(document.body);var s,a=$.extend({},this.jq_element.offset(),{width:this.jq_element[0].offsetWidth,height:this.jq_element[0].offsetHeight}),r=e[0].offsetWidth,n=e[0].offsetHeight,o=t(this.options.gravity,this.jq_element[0]);switch(o.charAt(0)){case"n":s={top:a.top+a.height+this.options.offset,left:a.left+a.width/2-r/2};break;case"s":s={top:a.top-n-this.options.offset,left:a.left+a.width/2-r/2};break;case"e":s={top:a.top+a.height/2-n/2,left:a.left-r-this.options.offset};break;case"w":s={top:a.top+a.height/2-n/2,left:a.left+a.width+this.options.offset}}s.top+=this.options.offset_y,s.left+=this.options.offset_x,2==o.length&&(s.left="w"==o.charAt(1)?a.left+a.width/2-15:a.left+a.width/2-r+15),e.css(s).addClass("tipsy-"+o),e.find(".tipsy-arrow")[0].className="tipsy-arrow tipsy-arrow-"+o.charAt(0),this.options.className&&e.addClass(t(this.options.className,this.jq_element[0])),this.options.fade?e.stop().css({opacity:0,display:"block",visibility:"visible"}).animate({opacity:this.options.opacity},200):e.css({visibility:"visible",opacity:this.options.opacity})}},hide:function(){this.options.fade?this.tip().stop().fadeOut(200,function(){$(this).remove()}):this.tip().remove()},getTitle:function(){var t,t,i=this.jq_element,e=this.options,e=this.options;return"string"==typeof e.title?t=i.attr("title"==e.title?"original-title":e.title):"function"==typeof e.title&&(t=e.title.call(i[0])),t=(""+t).replace(/(^\s*|\s*$)/,""),t||e.fallback},tip:function(){return this.jq_tip?this.jq_tip:(this.jq_tip=$('<div class="tipsy"></div>').html('<div class="tipsy-arrow"></div><div class="tipsy-inner"></div>'),this.jq_tip,this.jq_tip.data("tipsy-pointee",this.jq_element[0]),this.jq_tip)}},kshf.Item=function(t,i){this.data=t,this.idIndex=i,this.selected=1,this.items=[],this.itemCount_Active=0,this.itemCount_Preview=0,this.dirtyFilter=!0,this.filterCache=[],this.isWanted=!0,this.wantedOrder=0,this.mappedDataCache=[],this.selectedForLink=!1,this.resultDOM=void 0,this.facetDOM=void 0},kshf.Item.prototype={id:function(){return this.data[this.idIndex]},setFilter:function(t,i){this.filterCache[t]!==i&&(this.filterCache[t]=i,this.dirtyFilter=!0)},f_selected:function(){return 0!==this.selected},f_included:function(){return this.selected>0},is_NONE:function(){return 0===this.selected},is_NOT:function(){return-1===this.selected},is_AND:function(){return 1===this.selected},is_OR:function(){return 2===this.selected},set_NONE:function(){void 0!==this.inList&&this.inList.splice(this.inList.indexOf(this),1),this.inList=void 0,this.selected=0,this._setFacetDOM()},set_NOT:function(t){this.is_NOT()||(this._insertToList(t),this.selected=-1,this._setFacetDOM())},set_AND:function(t){this.is_AND()||(this._insertToList(t),this.selected=1,this._setFacetDOM())},set_OR:function(t){this.is_OR()||(this._insertToList(t),this.selected=2,this._setFacetDOM())},_insertToList:function(t){void 0!==this.inList&&this.inList.splice(this.inList.indexOf(this),1),this.inList=t,t.push(this)},_setFacetDOM:function(){this.facetDOM&&this.facetDOM.setAttribute("selected",this.selected)},addItem:function(t){this.items.push(t),this.itemCount_Active++},updateWanted:function(t){if(!this.dirtyFilter)return!1;var i=this,e=this.isWanted;return this.isWanted=!0,this.filterCache.every(function(t){return i.isWanted=i.isWanted&&t,i.isWanted}),this.isWanted===!0&&e===!1?this.mappedDataCache.forEach(function(i){null!==i&&(i.h?i.b&&i.b.itemCount_Active++:i.forEach(function(i){i.itemCount_Active++,1===i.itemCount_Active&&i.facet&&(i.facet===t||i.facet.isLinked||i.mappedDataCache.forEach(function(t){null!==t&&(t.h?t.b&&t.b.itemCount_Active++:t.forEach(function(t){t.itemCount_Active++}))}))},this))},this):this.isWanted===!1&&e===!0&&this.mappedDataCache.forEach(function(i){null!==i&&(i.h?i.b&&i.b.itemCount_Active>0&&i.b.itemCount_Active--:i.forEach(function(i){i.itemCount_Active>0&&i.itemCount_Active--,0===i.itemCount_Active&&i.facet&&(i.facet===t||i.facet.isLinked||i.mappedDataCache.forEach(function(t){null!==t&&(t.h?t.b&&t.b.itemCount_Active>0&&t.b.itemCount_Active--:t.forEach(function(t){t.itemCount_Active>0&&t.itemCount_Active--}))}))},this))},this),this.dirtyFilter=!1,this.isWanted!==e},updateWanted_More:function(t){return this.isWanted?!1:this.updateWanted(t)},updateWanted_Less:function(t){return this.isWanted?this.updateWanted(t):!1},updatePreview:function(t){this.isWanted&&(this.resultDOM&&this.resultDOM.setAttribute("highlight",!0),this.facetDOM&&this.facet===t.parentFacet&&!this.facet.isLinked&&this.itemCount_Active>0&&this.items.forEach(function(t){t.updatePreview(this.facet)},this),this.mappedDataCache.forEach(function(i){null!==i&&(i.h?i.b&&i.b.itemCount_Active>0&&i.b.itemCount_Preview++:i.forEach(function(i){i.itemCount_Preview++,1===i.itemCount_Preview&&i.facet&&(i.facet.isLinked||i.facet===t||i.updatePreview(t))}))},this))},highlightAll:function(t,i){this.resultDOM&&this.resultDOM.setAttribute("highlight",i?"selected":!0),this.facetDOM&&this.facetDOM.setAttribute("highlight",i?"selected":!0),(!this.resultDOM||i)&&this.mappedDataCache.forEach(function(i){null!==i&&(i.h?i.h.setSelectedPosition(i.v):i.forEach(function(i){this.resultDOM&&i.resultDOM||i.highlightAll(t,!1)},this))},this)},nohighlightAll:function(t,i){this.resultDOM&&this.resultDOM.setAttribute("highlight",!1),this.facetDOM&&this.facetDOM.setAttribute("highlight",!1),(!this.resultDOM||i)&&this.mappedDataCache.forEach(function(i){null!==i&&(i.h?i.h.hideSelectedPosition(i.v):i.forEach(function(i){this.resultDOM&&i.resultDOM||i.nohighlightAll(t,!1)},this))},this)},setSelectedForLink:function(t){this.selectedForLink=t,this.resultDOM&&(this.resultDOM.setAttribute("selectLinked",t),d3.select(this.resultDOM).select(".itemSelectCheckbox").classed("fa-square-o",!t).classed("fa-check-square-o",t)),t===!1&&this.set_NONE()}},kshf.Filter=function(t,i){this.isFiltered=!1,this.filterSummaryBlock=null,this.name=i.name,this.browser=i.browser,this.filteredItems=i.filteredItems,this.onClear=i.onClear,this.onFilter=i.onFilter,this.hideCrumb=i.hideCrumb,this.text_header=i.text_header,this.text_item=i.text_item,this.how="All",this.facet=i.facet?i.facet:this,this.id=t,this.isFiltered=!1,this.filteredItems.forEach(function(t){t.setFilter(this.id,!0)},this)},kshf.Filter.prototype={addFilter:function(t,i){var e=this.facet.parentFacet;this.browser.itemsSelectedCt,this.isFiltered=!0,this.onFilter&&this.onFilter.call(this.facet,this);var s=!1;void 0===i&&(i=!0);var a=0;"LessResults"===this.how&&(a=-1),"MoreResults"===this.how&&(a=1),this.filteredItems.forEach(function(t){if(!(0>a&&!t.isWanted||a>0&&t.isWanted)){var r=t.updateWanted(i);s=s||r}e&&e.hasAttribs()&&(t.isWanted?t.set_OR(e.attribFilter.attribs_OR):t.set_NONE())},this),e&&e.hasAttribs()&&(e.updateAttribCount_Wanted(),e.attribFilter.how="All",e.attribFilter.addFilter(!1,e),e._update_Selected()),this.refreshFilterSummary(),t===!0&&(this.browser.updateItemSelectedCt(),this.browser.refreshFilterClearAll(),s&&this.browser.update(-1),sendLog&&sendLog(kshf.LOG.FILTER_ADD,this.browser.getFilteringState()))},clearFilter:function(t,i){if(this.isFiltered){var e=this.facet.parentFacet;this.browser.itemsSelectedCt,this.isFiltered=!1,this.filteredItems.forEach(function(t){t.setFilter(this.id,!0)},this),this.onClear&&this.onClear.call(this.facet,this),void 0===i&&(i=!0),this.filteredItems.forEach(function(t){t.isWanted||t.updateWanted(i),e&&e.hasAttribs()&&t.isWanted&&t.set_OR(e.attribFilter.attribs_OR)},this),this.refreshFilterSummary(),t===!0&&(e&&e.hasAttribs()&&(e.updateAttribCount_Wanted(),e.attribFilter.how="All",e.attribCount_Wanted===e.attribCount_Total?e.attribFilter.clearFilter(!1,e):e.attribFilter.addFilter(!1,e)),this.browser.updateItemSelectedCt(),this.browser.refreshFilterClearAll(),this.browser.update(1),sendLog&&sendLog(kshf.LOG.FILTER_CLEAR,this.browser.getFilteringState()))}},refreshFilterSummary:function(){if(void 0===this.hideCrumb&&this.browser.subBrowser!==!0&&this.browser.isSmallWidth()&&(this.hideCrumb=!0),this.hideCrumb!==!0)if(this.isFiltered){if(null===this.filterSummaryBlock&&(this.filterSummaryBlock=this.insertFilterSummaryBlock()),void 0!==this.text_header){var t=this.text_header;"function"==typeof t&&(t=t.call(this.facet,this)),this.browser.subBrowser===!0&&(t+=" ("+this.browser.itemName+")"),this.filterSummaryBlock.select(".txttt").html(t+": ")}if(void 0!==this.text_item){var t=this.text_item;"function"==typeof t&&(t=t.call(this.facet,this)),this.filterSummaryBlock.select(".filter_item").html(t)}}else{var i=this.filterSummaryBlock;if(null===i||void 0===i)return;i.attr("ready",!1),setTimeout(function(){i[0][0].parentNode.removeChild(i[0][0])},350),this.filterSummaryBlock=null}},insertFilterSummaryBlock:function(){var t,i=this;t=this.browser.dom.filtercrumbs.append("span").attr("class","filter-block"),t.append("span").attr("class","chartClearFilterButton summary").each(function(){this.tipsy=new Tipsy(this,{gravity:"n",title:function(){return"<span class='action'>Remove</span> filter"}})}).on("click",function(){this.tipsy.hide(),i.clearFilter(!0),setTimeout(function(){i.browser.updateLayout_Height()},1e3),sendLog&&sendLog(kshf.LOG.FILTER_CLEAR_CRUMB,{id:this.id})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide(),d3.event.stopPropagation()}).append("span").attr("class","fa fa-times");var e=t.append("span").attr("class","sdsdsds");return e.append("span").attr("class","txttt"),e.append("span").attr("class","filter_item"),window.getComputedStyle(t[0][0]).opacity,t.attr("ready",!0),t}},kshf.List=function(t,i,e){var s=this;this.browser=t,this.dom={},this.scrollTop_cache=0,this.itemtoggledetailsWidth=18,this.stateWidth=15,this.linkColumnWidth=85,this.linkColumnWidth_ItemCount=25,this.linkColumnWidth_BarMax=this.linkColumnWidth-this.linkColumnWidth_ItemCount-3,this.selectColumnWidth=17,this.config=i,this.contentFunc=i.contentFunc,void 0!==i.content&&(this.contentFunc=this.browser.getColumnData(this.browser.primaryTableName,i.content)),this.autoExpandMore=!1,i.autoExpandMore&&(this.autoExpandMore=i.autoExpandMore),i.maxVisibleItems_Default&&(kshf.maxVisibleItems_default=i.maxVisibleItems_Default),this.maxVisibleItems=kshf.maxVisibleItems_default,this.hasLinkedItems=!1,void 0!==i.hasLinkedItems&&(this.hasLinkedItems=!0),this.hasLinkedItems&&(this.selectColumnWidth+=17,this.showSelectBox=!1,i.showSelectBox===!0&&(this.showSelectBox=!0),this.showSelectBox&&(this.selectColumnWidth+=17)),this.domStyle=i.domStyle,this.sortingOpts=i.sortingOpts,this.sortingOpts.forEach(function(t){void 0===t.value&&(t.value=this.browser.getColumnData(this.browser.primaryTableName,t.name)),t.label||(t.label=t.value),void 0===t.inverse&&(t.inverse=!1),void 0===t.func&&(t.func=s.getSortFunc(t.value))},this),this.sortingOpt_Active=this.sortingOpts[0],this.displayType="list","grid"===i.displayType&&(this.displayType="grid"),this.visibleCb=i.visibleCb,this.detailCb=i.detailCb,this.sortColWidth=i.sortColWidth,this.linkText="Related To",i.linkText&&(this.linkText=i.linkText),this.showRank=i.showRank,void 0===this.showRank&&(this.showRank=!1),this.textSearch=i.textSearch,this.textSearchFunc=i.textSearchFunc,void 0!==this.textSearch&&(void 0===this.textSearchFunc&&(this.textSearchFunc=this.browser.getColumnData(this.browser.primaryTableName,this.textSearch)),"*"===this.textSearch[0]&&(this.textSearch=this.textSearch.substring(1)),this.textSearch=kshf.Util.toProperCase(this.textSearch)),this.hideTextSearch=void 0===this.textSearchFunc,this.detailsToggle=i.detailsToggle,this.detailsToggle=void 0===this.detailsToggle?"off":this.detailsToggle.toLowerCase(),this.listDiv=e.select("div.listDiv").attr("detailsToggle",this.detailsToggle).attr("displayType",this.displayType),this.dom.leftBlockAdjustSize=this.listDiv.append("span").attr("class","leftBlockAdjustSize").attr("title","Drag to adjust panel width").on("mousedown",function(){if(1===d3.event.which){s.browser.root.style("cursor","ew-resize"),s.browser.root.attr("noanim",!0);var t=d3.mouse(this.parentNode.parentNode)[0],i=s.browser.barChartWidth;s.browser.root.on("mousemove",function(){var e=d3.mouse(this)[0],a=e-t,r=s.hideBarAxis;s.browser.setBarWidthLeftPanel(i+a),s.browser.hideBarAxis!==r&&s.browser.updateLayout_Height()}).on("mouseup",function(){s.browser.root.style("cursor","default"),s.browser.root.attr("noanim",!1),s.browser.root.on("mousemove",null).on("mouseup",null),sendLog&&sendLog(kshf.LOG.BARCHARTWIDTH,{info:s.browser.barChartWidth})}),d3.event.preventDefault()}}).on("click",function(){d3.event.stopPropagation(),d3.event.preventDefault()}),this.dom.listHeader=this.listDiv.append("div").attr("class","listHeader"),this.dom.listHeader_TopRow=this.dom.listHeader.append("div").attr("class","topRow"),this.dom.listHeader_BottomRow=this.dom.listHeader.append("div").attr("class","bottomRow"),this.dom.listItemGroup=this.listDiv.append("div").attr("class","listItemGroup").on("scroll",function(){this.scrollHeight-this.scrollTop-this.offsetHeight<10?s.autoExpandMore===!1?s.dom.showMore.style("bottom","4px"):s.showMore():s.dom.showMore.style("bottom","-27px"),s.dom.scrollToTop.style("visibility",this.scrollTop>0?"visible":"hidden")}),this.sortFilters=[],"list"===this.displayType&&this.sortingOpts.forEach(function(i){this.sortFilters.push(t.createFilter({name:i.name,browser:this.browser,filteredItems:this.browser.items,facet:this,onClear:function(t){t.filterValue=""},onFilter:function(t){var i=this.sortingOpt_Active.label;t.filteredItems.forEach(function(e){e.setFilter(t.id,i(e)===t.filterValue)})},text_header:i.name,text_item:function(t){return"<b>"+t.filterValue+"</b>"}}))},this),this.sortFilter_Active=this.sortFilters[0],this.dom.scrollToTop=this.dom.listHeader_BottomRow.append("div").attr("class","scrollToTop").html("⬆").attr("title","Scroll To Top").on("click",function(){kshf.Util.scrollToPos_do(s.dom.listItemGroup[0][0],0),sendLog&&sendLog(kshf.LOG.LIST_SCROLL_TOP)}),this.insertHeaderSortSelect(),this.insertHeaderLinkedItems(),this.sortItems(),this.insertItems(),this.dom.showMore=this.listDiv.append("div").attr("class","showMore").on("click",function(){s.showMore()}).on("mouseenter",function(){d3.select(this).selectAll(".loading_dots").attr("anim",!0)}).on("mouseleave",function(){d3.select(this).selectAll(".loading_dots").attr("anim",null)}),this.dom.showMore.append("span").attr("class","MoreText").html("Show More"),this.dom.showMore.append("span").attr("class","Count CountAbove"),this.dom.showMore.append("span").attr("class","Count CountBelow"),this.dom.showMore.append("span").attr("class","loading_dots loading_dots_1"),this.dom.showMore.append("span").attr("class","loading_dots loading_dots_2"),this.dom.showMore.append("span").attr("class","loading_dots loading_dots_3")},kshf.List.prototype={insertHeaderTextSearch:function(){var t,i=this;this.textFilter=this.browser.createFilter({name:"TextSearch",browser:this.browser,filteredItems:this.browser.items,facet:this,onClear:function(i){i.filterStr="",this.dom.mainTextSearch[0][0].value="",t.select(".clearText").style("display","none")},onFilter:function(e){e.filterStr=e.filterStr.split(" "),t.select(".clearText").style("display","inline-block"),e.filteredItems.forEach(function(t){var s=!e.filterStr.every(function(e){var s=i.textSearchFunc(t);return null===s||void 0===s?!0:-1===s.toLowerCase().indexOf(e)});t.setFilter(e.id,s)})},hideCrumb:!0}),t=this.dom.listHeader_TopRow.append("span").attr("class","mainTextSearch"),t.append("i").attr("class","fa fa-search searchIcon"),this.dom.mainTextSearch=t.append("input").attr("placeholder","Search "+(this.textSearch?this.textSearch:"title")).attr("autofocus","true").on("keydown",function(){var t=this;this.timer&&(clearTimeout(this.timer),this.timer=null),this.timer=setTimeout(function(){i.textFilter.filterStr=t.value.toLowerCase(),""!==i.textFilter.filterStr?i.textFilter.addFilter(!0):i.textFilter.clearFilter(!0),sendLog&&sendLog(kshf.LOG.FILTER_TEXTSEARCH,{id:i.textFilter.id,info:i.textFilter.filterStr}),t.timer=null},750)}),t.append("i").attr("class","fa fa-times-circle clearText").on("click",function(){i.textFilter.clearFilter(!0)})},insertHeaderSortSelect:function(){var t=this,i=this.dom.listHeader_BottomRow.append("div").attr("class","listsortcolumn").style("width",this.sortColWidth+"px").style("white-space","nowrap");return"grid"===t.displayType&&i.append("span").attr("class","sortBy fa fa-sort-amount-desc"),1===this.sortingOpts.length?(i.append("span").html(this.sortingOpts[0].name),void 0):(i.append("select").attr("class","listSortOptionSelect").style("width",this.sortColWidth-("grid"===t.displayType?15:0)+"px").on("change",function(){t.sortingOpt_Active=t.sortingOpts[this.selectedIndex],t.sortFilter_Active=t.sortFilters[this.selectedIndex],t.reorderItemsOnDOM(),t.updateVisibleIndex(),t.maxVisibleItems=kshf.maxVisibleItems_default,t.updateItemVisibility(),"list"===t.displayType&&t.dom.listsortcolumn_label.html(function(i){return t.sortingOpt_Active.label(i)}).each(function(i){this.columnValue=t.sortingOpt_Active.label(i)}),sendLog&&sendLog(kshf.LOG.LIST_SORT,{info:this.selectedIndex})}).selectAll("input.list_sort_label").data(this.sortingOpts).enter().append("option").attr("class","list_sort_label").html(function(t){return t.name}),void 0)},insertHeaderLinkedItems:function(){var t=this,i=this.dom.listHeader_BottomRow.append("span").attr("class","headerLinkStateColumn");this.hasLinkedItems&&(i.append("span").attr("class","linkTitleText").text(this.linkText+": "),i.append("span").attr("class","fa fa-link").each(function(){this.tipsy=new Tipsy(this,{gravity:"n",title:function(){return"<span class='action'>Show</span> all <br>"+t.linkText+"<br>results"}})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}).on("click",function(){t.browser.items.forEach(function(t){t.isWanted&&t.setSelectedForLink(!0)}),t.browser.clearFilters_All(!1),t.browser.linkedFacets.forEach(function(t){t.updateSorting(0),t.selectAllAttribsButton()}),setTimeout(function(){t.browser.updateLayout_Height()},1e3)}),this.showSelectBox&&i.append("span").attr("class","fa fa-check-square-o").each(function(){this.tipsy=new Tipsy(this,{gravity:"n",title:function(){return"<span class='action'>Select</span> all results"}})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}).on("click",function(){t.browser.items.forEach(function(t){t.isWanted&&t.setSelectedForLink(!0)}),t.browser.linkedFacets.forEach(function(t){t.updateSorting(0)}),setTimeout(function(){t.browser.updateLayout_Height()},1e3)}))},insertItems:function(){var t=this;this.dom.listItems=this.dom.listItemGroup.selectAll("div.listItem").data(this.browser.items,function(t){return t.id()}).enter().append("div").attr("class",function(i){var e="listItem";return t.domStyle&&(e+=" "+t.domStyle.call(this,i)),e}).attr("details","false").attr("highlight",!1).attr("animSt","visible").attr("itemID",function(t){return t.id()}).each(function(t){t.resultDOM=this}).on("mouseover",function(i){i.highlightAll(t,!0),i.items.forEach(function(i){i.highlightAll(t,!1)})}).on("mouseout",function(i){d3.select(this).attr("highlight","false"),i.nohighlightAll(t,!0),i.items.forEach(function(i){i.nohighlightAll(t,!1)})}),this.hasLinkedItems&&this.dom.listItems.attr("selectLinked","false"),"list"===this.displayType&&this.insertItemSortColumn(),"off"!==this.detailsToggle&&this.insertItemToggleDetails(),this.dom.listItems_Content=this.dom.listItems.append("div").attr("class","content").html(function(i){return t.contentFunc(i)}),this.hasLinkedItems&&(this.dom.itemLinkStateColumn=this.dom.listItems.append("span").attr("class","itemLinkStateColumn").style("width",this.selectColumnWidth+"px"),this.dom.itemLinkStateColumn.append("span").attr("class","itemLinkIcon fa fa-link").each(function(){this.tipsy=new Tipsy(this,{gravity:"n",title:function(){return"<span class='action'>Show</span> "+t.linkText}})}).on("mouseenter",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}).on("click",function(i){this.tipsy.hide(),t.browser.items.forEach(function(t){t.setSelectedForLink(!1)}),i.setSelectedForLink(!0),t.browser.clearFilters_All(!1),t.browser.linkedFacets.forEach(function(t){t.selectAllAttribsButton(),t.updateSorting(0)}),setTimeout(function(){t.browser.updateLayout_Height()},1e3)}),this.showSelectBox&&this.dom.itemLinkStateColumn.append("i").attr("class","itemSelectCheckbox fa fa-square-o").each(function(){this.tipsy=new Tipsy(this,{gravity:"n",title:function(){return"<span class='action'>Select</span> item"}})}).on("mouseenter",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}).on("click",function(i){this.tipsy.hide(),i.setSelectedForLink(!i.selectedForLink),t.browser.linkedFacets.forEach(function(t){t.updateSorting(0)}),t.browser.updateLayout_Height()}))},insertItemSortColumn:function(){var t=this;this.dom.listsortcolumn=this.dom.listItems.append("div").attr("class","listsortcolumn").style("width",this.sortColWidth+"px").each(function(i){this.columnValue=t.sortingOpt_Active.label(i)}).each(function(){this.tipsy=new Tipsy(this,{gravity:"s",title:function(){return"<span class='fa fa-plus'></span> <span class='action'>Add</span> <i>"+t.sortingOpt_Active.name+"</i> Filter"}})}).on("mouseover",function(){t.sortFilter_Active.isFiltered||this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}).on("click",function(){t.sortFilter_Active.isFiltered||(this.tipsy.hide(),t.sortFilter_Active.filterValue=this.columnValue,t.sortFilter_Active.addFilter(!0))}),this.dom.listsortcolumn_label=this.dom.listsortcolumn.append("span").attr("class","columnLabel").html(function(i){return t.sortingOpt_Active.label(i)}),this.showRank&&(this.dom.ranks=this.dom.listsortcolumn.append("span").attr("class","itemRank"))},insertItemToggleDetails:function(){var t=this;"one"===this.detailsToggle&&"list"===this.displayType&&this.dom.listItems.append("div").attr("class","itemToggleDetails").each(function(t){this.tipsy=new Tipsy(this,{gravity:"s",title:function(){return t.showDetails===!0?"Show less":"Show more"}})}).append("span").attr("class","item_details_toggle fa fa-chevron-down").on("click",function(i){i.showDetails===!0?t.hideListItemDetails(i):t.showListItemDetails(i),this.parentNode.tipsy.hide()}).on("mouseover",function(){this.parentNode.tipsy.show()}).on("mouseout",function(){this.parentNode.tipsy.hide()}),"zoom"===this.detailsToggle&&this.dom.listItems.append("div").attr("class","itemToggleDetails").each(function(){this.tipsy=new Tipsy(this,{gravity:"s",title:function(){return"Zoom into item"}})}).append("span").attr("class","item_details_toggle fa fa-bullseye").on("click",function(i){this.parentNode.tipsy.hide(),t.browser.updateItemZoomText(i),t.browser.layout_infobox.attr("show","itemZoom")}).on("mouseover",function(){this.parentNode.tipsy.show()}).on("mouseout",function(){this.parentNode.tipsy.hide()})},hideListItemDetails:function(t){t.resultDOM.setAttribute("details",!1),t.showDetails=!1,this.lastSelectedItem=void 0,sendLog&&sendLog(kshf.LOG.ITEM_DETAIL_OFF,{info:t.id()})},showListItemDetails:function(t){this.lastSelectedItem&&(this.lastSelectedItem.resultDOM.setAttribute("details",!1),this.lastSelectedItem.showDetails=!1),t.resultDOM.setAttribute("details",!0),t.showDetails=!0,this.lastSelectedItem=t,this.detailCb&&this.detailCb.call(this,t),sendLog&&sendLog(kshf.LOG.ITEM_DETAIL_ON,{info:t.id()})},updateShowListGroupBorder:function(){if("list"===this.displayType)if(this.sortingOpt_Active.noGroupBorder===!0)this.dom.listItems.style("border-top-width","0px");else{var t=null,i=this.sortingOpt_Active.value,e=this.sortingOpt_Active.func;this.browser.items.forEach(function(s){s.isWanted&&(null!==t&&void 0!==s.resultDOM&&(s.resultDOM.style.borderTopWidth=0!==e(i(s),i(t))?"4px":"0px"),t=s)})}},showMore:function(){this.maxVisibleItems*=2,this.updateItemVisibility(!0),this.dom.showMore.style("bottom","-27px"),sendLog&&sendLog(kshf.LOG.LIST_SHOWMORE,{info:this.maxVisibleItems})},reorderItemsOnDOM:function(){this.sortItems(),this.dom.listItems=this.dom.listItemGroup.selectAll("div.listItem").data(this.browser.items,function(t){return t.id()}).order()},sortItems:function(){var t=this.sortingOpt_Active.value,i=this.sortingOpt_Active.func,e=this.sortingOpt_Active.inverse;this.browser.items.sort(function(s,a){var r=t(s),n=t(a);if(void 0===r&&void 0!==n)return 1;if(void 0===n&&void 0!==r)return-1;if(void 0===n&&void 0===r)return 0;var o=i(r,n);return 0===o&&(o=a.id()-s.id()),e?-o:o})},getSortFunc:function(t){for(var i,e,s,a=0,s=0;!0;a++){if(3===s||a===this.browser.items.length){i=e;break}var r,n=this.browser.items[a],o=t(n);switch(typeof o){case"string":r=kshf.Util.sortFunc_List_String;break;case"number":r=kshf.Util.sortFunc_List_Number;break;case"object":r=o instanceof Date?kshf.Util.sortFunc_List_Date:kshf.Util.sortFunc_List_Number;break;default:r=kshf.Util.sortFunc_List_Number
}r===e?s++:(e=r,s=0)}return i},updateItemVisibility:function(t){var i=this,e="list"===this.displayType?"block":"inline-block",s=0;this.dom.listItems.each(function(a){var r=this,n=a.wantedOrder>=0&&a.wantedOrder<i.maxVisibleItems;if(n&&s++,n&&i.visibleCb&&i.visibleCb.call(this,a),t)return this.style.display=n?e:"none",this.setAttribute("animSt","visible"),void 0;var o=a.wantedOrder>=0&&a.wantedOrder<50,h=a.wantedOrder_pre>=0&&a.wantedOrder_pre<50;o?h?(this.setAttribute("animSt","visible"),this.style.display=n?e:"none"):(this.style.display=e,r.setAttribute("animSt","closed"),setTimeout(function(){r.setAttribute("animSt","open")},500),setTimeout(function(){r.setAttribute("animSt","visible")},1100+10*a.wantedOrder)):h&&n===!1?(setTimeout(function(){r.setAttribute("animSt","open")},10*-a.wantedOrder),setTimeout(function(){r.setAttribute("animSt","closed")},500),setTimeout(function(){r.style.display="none"},1e3)):(this.setAttribute("animSt","visible"),this.style.display=n?e:"none")});var a=this.browser.itemsSelectedCt-s;this.dom.showMore.style("display",0===a?"none":"block"),this.dom.showMore.select(".CountAbove").html("&#x25B2;"+s+" shown"),this.dom.showMore.select(".CountBelow").html(a+" below&#x25BC;")},updateContentWidth:function(t){t-=4,t-=this.browser.scrollWidth,this.dom.showMore.style("width",t-5+"px"),t-=this.sortColWidth,"off"!==this.detailsToggle&&(t-=this.itemtoggledetailsWidth),this.browser.dom.filtercrumbs.style("width",t-15+"px"),this.hasLinkedItems&&(t-=this.selectColumnWidth),"list"===this.displayType&&this.dom.listItems_Content.style("width",t+"px")},updateAfterFiltering_do:function(){this.updateVisibleIndex(),this.maxVisibleItems=kshf.maxVisibleItems_default,this.updateItemVisibility(!1)},updateAfterFilter:function(){var t=this,i=null,e=this.dom.listItemGroup[0][0],s=e.scrollTop,a=d3.ease("cubic-in-out"),r=1e3,n=function(o){var h;null===i&&(i=o),h=(o-i)/r,e.scrollTop=(1-a(h))*s,0===e.scrollTop?t.updateAfterFiltering_do():window.requestAnimationFrame(n)};window.requestAnimationFrame(n)},updateVisibleIndex:function(){var t=0,i=1;this.browser.items.forEach(function(e){e.wantedOrder_pre=e.wantedOrder,e.isWanted?(e.wantedOrder=t,t++):(e.wantedOrder=-i,i++)},this),this.showRank&&this.dom.ranks.text(function(t){return"#"+(t.wantedOrder+1)})}},kshf.Browser=function(t){this.options=t,this.facets=[],this.facetsTop=[],this.facetsBottom=[],this.facetsLeft=[],this.facetsRight=[],this.linkedFacets=[],this.maxFilterID=0,this.barChartWidth=0,this.scrollWidth=21,this.sepWidth=10,this.line_height=18,this.filterList=[],this.pauseResultPreview=!1,this.columnsSkip=t.columnsSkip,this.categoryTextWidth=t.categoryTextWidth,void 0===this.categoryTextWidth&&(this.categoryTextWidth=115),this.rightPanelLabelWidth=this.categoryTextWidth,this.leftPanelLabelWidth=this.categoryTextWidth,t.leftPanelLabelWidth&&(this.leftPanelLabelWidth=t.leftPanelLabelWidth),t.rightPanelLabelWidth&&(this.rightPanelLabelWidth=t.rightPanelLabelWidth),"number"==typeof t.barChartWidth&&(this.barChartWidthInit=t.barChartWidth),this.subBrowser=t.subBrowser,this.facetDefs=t.facets,t.charts&&(this.facetDefs=t.charts),this.listDef=t.itemDisplay,t.list&&(this.listDef=t.list),this.listMaxColWidthMult=t.listMaxColWidthMult?t.listMaxColWidthMult:.25,this.domID=t.domID,this.source=t.source,this.source.loadedTableCount=0,this.loadedCb=t.loadedCb,this.readyCb=t.readyCb,this.updateCb=t.updateCb,this.dom={},this.itemName=void 0!==t.itemName?t.itemName:this.source.sheets[0].name,this.primItemCatValue=null,"string"==typeof t.catValue&&(this.primItemCatValue=t.catValue),this.showDataSource=!0,void 0!==t.showDataSource&&(this.showDataSource=t.showDataSource),this.forceHideBarAxis=!1,void 0!==t.forceHideBarAxis&&(this.forceHideBarAxis=t.forceHideBarAxis),this.TopRoot=d3.select(this.domID).classed("kshfHost",!0).style("position","relative").style("overflow-y","hidden");for(var i=this.TopRoot[0][0];i.hasChildNodes();)i.removeChild(i.lastChild);this.root=this.TopRoot.attr("noanim",!1),t.showResizeCorner===!0&&this.insertResize(),this.insertInfobox(),this.layoutTop=this.root.append("div").attr("class","kshf layout_top"),this.layoutLeft=this.root.append("div").attr("class","kshf layout_left"),this.layoutRight=this.root.append("div").attr("class","kshf layout_right"),this.layoutList=this.root.append("div").attr("class","kshf listDiv"),this.layoutBottom=this.root.append("div").attr("class","kshf layout_bottom"),this.loadSource()},kshf.Browser.prototype={getWidth_LeftPanel:function(){return this.leftPanelLabelWidth+this.getWidth_QueryPreview()+this.barChartWidth+this.scrollWidth},getWidth_RightPanel:function(){return this.rightPanelLabelWidth+this.getWidth_QueryPreview()+this.barChartWidth+this.scrollWidth},getWidth_Total:function(){return this.divWidth},getWidth_MidPanel:function(){var t=this.divWidth;return this.fullWidthResultSet()||(this.facetsLeft.length>0&&(t-=this.getWidth_LeftPanel()+2),this.facetsRight.length>0&&(t-=this.getWidth_RightPanel()+2)),t},domHeight:function(){return parseInt(this.TopRoot.style("height"))},domWidth:function(){return parseInt(this.TopRoot.style("width"))},createFilter:function(t){var i=new kshf.Filter(this.maxFilterID,t);return++this.maxFilterID,this.filterList.push(i),i},insertResize:function(){var t=this;this.root.append("div").attr("class","kshf layout_resize").on("mousedown",function(){t.root.style("cursor","nwse-resize"),t.root.attr("noanim",!0);var i=d3.mouse(d3.select("body")[0][0])[0],e=d3.mouse(d3.select("body")[0][0])[1],s=parseInt(d3.select(this.parentNode).style("width")),a=parseInt(d3.select(this.parentNode).style("height"));d3.select("body").on("mousemove",function(){var r=d3.mouse(d3.select("body")[0][0])[0]-i,n=d3.mouse(d3.select("body")[0][0])[1]-e;d3.select(t.domID).style("height",a+n+"px"),d3.select(t.domID).style("width",s+r+"px"),t.updateLayout()}).on("mouseup",function(){sendLog&&sendLog(kshf.LOG.RESIZE),t.root.style("cursor","default"),t.root.attr("noanim",!1),d3.select("body").on("mousemove",null).on("mouseup",null)}),d3.event.preventDefault()})},insertInfobox:function(){var t=this,i="";i+="<div align='center'>",i+="<div class='header'>This data browser is created by <span class='libName'>Keshif</span>.</div>",i+="<div align='center' class='boxinbox project_credits'>",i+="<div>Developed by</div>",i+=" <a href='http://www.cs.umd.edu/hcil/' target='_blank'><img src='https://wiki.umiacs.umd.edu/hcil/images/1/10/HCIL_logo_small_no_border.gif' style='height:50px'></a>",i+=" <a class='myName' href='http://www.adilyalcin.me' target='_blank'>M. Adil Yalçın</a>",i+=" <a href='http://www.umd.edu' target='_blank'><img src='http://www.trademarks.umd.edu/marks/gr/informal.gif' style='height:50px'></a>",i+="</div>",i+="",i+="<div align='center' class='boxinbox project_credits'>",i+="<div style='float:right; text-align: right'>",i+="<iframe src='http://ghbtns.com/github-btn.html?user=adilyalcin&repo=Keshif&type=watch&count=true' allowtransparency='true' frameborder='0' scrolling='0' width='90px' height='20px'></iframe><br/>",i+="</div>",i+="<div style='float:left; padding-left: 10px'>",i+="<iframe src='http://ghbtns.com/github-btn.html?user=adilyalcin&repo=Keshif&type=fork&count=true' allowtransparency='true' frameborder='0' scrolling='0' width='90px' height='20px'></iframe>",i+="</div>",i+=" 3rd party libraries and APIs:<br/>",i+=" <a href='http://d3js.org/' target='_blank'>D3</a> -",i+=" <a href='http://jquery.com' target='_blank'>JQuery</a> -",i+=" <a href='https://developers.google.com/chart/' target='_blank'>GoogleDocs</a>",i+="</div><br/>",i+="",i+="<div align='center' class='project_fund'>",i+="Keshif (<a target='_blank' href='http://translate.google.com/#auto/en/ke%C5%9Fif'><i>keşif</i></a>) means discovery / exploration in Turkish.<br/>",i+="Funded in part by <a href='http://www.huawei.com'>Huawei</a>. </div>",i+="",this.layout_infobox=this.root.append("div").attr("class","kshf layout_infobox").attr("show","loading"),this.layout_infobox.append("div").attr("class","background").on("click",function(){t.layout_infobox.attr("show","none")}),this.dom.loadingBox=this.layout_infobox.append("div").attr("class","infobox_content infobox_loading");var e=this.dom.loadingBox.append("span").attr("class","loadinggg");e.append("span").attr("class","loading_dots loading_dots_1").attr("anim",!0),e.append("span").attr("class","loading_dots loading_dots_2").attr("anim",!0),e.append("span").attr("class","loading_dots loading_dots_3").attr("anim",!0);var s=this.dom.loadingBox.append("div").attr("class","status_text");s.append("span").attr("class","info").text("Loading data sources..."),s.append("span").attr("class","dynamic").text(void 0!==this.source.sheets?"("+this.source.loadedTableCount+"/"+this.source.sheets.length+")":"");var a=this.layout_infobox.append("div").attr("class","infobox_content infobox_credit");a.append("div").attr("class","infobox_close_button").on("click",function(){t.layout_infobox.attr("show","none")}).append("span").attr("class","fa fa-times"),a.append("div").attr("class","all-the-credits").html(i),this.dom.infobox_itemZoom=this.layout_infobox.append("span").attr("class","infobox_content infobox_itemZoom"),this.dom.infobox_itemZoom.append("div").attr("class","infobox_close_button").on("click",function(){t.layout_infobox.attr("show","none")}).append("span").attr("class","fa fa-times"),this.dom.infobox_itemZoom_content=this.dom.infobox_itemZoom.append("span").attr("class","content")},updateItemZoomText:function(t){var i="";if(kshf.dt_ColNames[this.primaryTableName]){var e=kshf.dt_ColNames[this.primaryTableName];for(var s in e)i+="<b>"+s+":</b> "+t.data[e[s]].toString()+"<br>"}else for(var s in t.data){var a=t.data[s];void 0!==a&&null!==a&&(i+="<b>"+s+":</b> "+a.toString()+"<br>")}this.dom.infobox_itemZoom_content.html(i)},insertClearAll:function(){var t=this;return void 0===this.listDisplay?(this.dom.filterClearAll=this.root.select(".ffffffff"),void 0):(this.dom.filterClearAll=this.listDisplay.dom.listHeader_TopRow.append("span").attr("class","filterClearAll").each(function(){this.tipsy=new Tipsy(this,{gravity:"n",title:function(){return"<span class='action'>Remove</span> all filters"}})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide(),d3.event.stopPropagation()}).on("click",function(){this.tipsy.hide(),t.clearFilters_All()}),this.dom.filterClearAll.append("span").attr("class","title").text("Clear"),this.dom.filterClearAll.append("div").attr("class","chartClearFilterButton allFilter").append("span").attr("class","fa fa-times"),void 0)},showInfoBox:function(){this.layout_infobox.attr("show","credit"),sendLog&&sendLog(kshf.LOG.INFOBOX)},loadSource:function(){this.source.sheets&&(this.source.sheets[0].primary=!0,this.primaryTableName=this.source.sheets[0].name,this.source.sheets.forEach(function(t){return void 0===t.id&&(t.id="id"),void 0===t.tableName&&(t.tableName=t.name),void 0!==kshf.dt[t.tableName]?(this.incrementLoadedSheetCount(),void 0):(this.source.gdocId?(this.source.url="https://docs.google.com/spreadsheet/ccc?key="+this.source.gdocId,this.loadSheet_Google(t)):this.source.dirPath?this.loadSheet_File(t):t.data&&this.loadSheet_Memory(t),void 0)},this)),this.source.callback&&this.source.callback(this)},loadSheet_Google:function(t){var i=this,e=kshf.queryURL_base+this.source.gdocId+"&headers=1";e+=t.sheetID?"&gid="+t.sheetID:"&sheet="+t.name,t.range&&(e+="&range="+t.range);var s=new google.visualization.Query(e);t.query&&s.setQuery(t.query),s.send(function(e){if(void 0!==kshf.dt[t.tableName])return i.incrementLoadedSheetCount(),void 0;if(e.isError())return i.layout_infobox.select("div.status_text .info").text("Cannot load data"),i.layout_infobox.select("span.loadinggg").selectAll("span").remove(),i.layout_infobox.select("span.loadinggg").append("i").attr("class","fa fa-warning"),i.layout_infobox.select("div.status_text .dynamic").text("("+e.getMessage()+")"),void 0;var s,a,r,n=[],o=-1,h=0,l=e.getDataTable(),c=l.getNumberOfColumns();for(r=0;!0;r++)if(r===c||l.getColumnLabel(r).trim()===t.id){o=r;break}for(n.length=l.getNumberOfRows(),a=0;a<l.getNumberOfRows();a++){var d=[];for(d.length=c,r=0;c>r;r++)d[r]=l.getValue(a,r);o===c&&d.push(h++),n[a]=new kshf.Item(d,o)}for(kshf.createColumnNames(t.tableName),s=0;s<l.getNumberOfColumns();s++)kshf.insertColumnName(t.tableName,l.getColumnLabel(s).trim(),s);i.finishDataLoad(t,n)})},loadSheet_File:function(t){var i=this,e=this.source.dirPath+t.name+"."+this.source.fileType;$.ajax({url:e,type:"GET",async:void 0===i.source.callback?!0:!1,contentType:"text/csv",success:function(e){if(void 0!==kshf.dt[t.tableName])return i.incrementLoadedSheetCount(),void 0;var s=[],a=t.id,r=void 0===a,n={};n.dynamicTyping=!0,n.header=!0,t.header===!1&&(n.header=!1),t.preview&&(n.preview=t.preview);var o=Papa.parse(e,n);o.data.forEach(function(t,i){r&&t.push(i),s.push(new kshf.Item(t,a))}),i.finishDataLoad(t,s)}})},loadSheet_Memory:function(t){var i,e=[],s=-1,a=0;return void 0!==kshf.dt[t.tableName]?(this.incrementLoadedSheetCount(),void 0):(this.createColumnNames(t.tableName),t.data.forEach(function(r,n){0===n?(r.forEach(function(i,e){kshf.insertColumnName(t.tableName,i,e),i===t.id&&(s=e)}),-1===s&&(kshf.insertColumnName(t.tableName,t.id,i),s=i)):(s===r.length&&r.push(a++),e.push(new kshf.Item(r,s)))}),this.finishDataLoad(t,e),void 0)},createTableFromTable:function(t,i,e,s){var a=0;kshf.dt_id[i]={},kshf.dt[i]=[];var r=kshf.dt_id[i],n=kshf.dt[i];t.forEach(function(t){var i=e(t);if(""!==i&&void 0!==i&&null!==i)if(i instanceof Array)i.forEach(function(t){if(""!==t&&void 0!==t&&null!==t&&!r[t]){var i=[a++,t];s&&i.push(s(t));var e=new kshf.Item(i,0);r[t]=e,n.push(e)}});else if(!r[i]){var o=[a++,i];s&&o.push(s(v2));var h=new kshf.Item(o,0);r[i]=h,n.push(h)}})},finishDataLoad:function(t,i){kshf.dt[t.tableName]=i;var e={};i.forEach(function(t){e[t.id()]=t}),kshf.dt_id[t.tableName]=e,this.incrementLoadedSheetCount()},incrementLoadedSheetCount:function(){var t=this;this.source.loadedTableCount++,this.layout_infobox.select("div.status_text .dynamic").text("("+this.source.loadedTableCount+"/"+this.source.sheets.length+")"),void 0===this.source.callback&&this.source.loadedTableCount===this.source.sheets.length&&(this.source.sheets.forEach(function(t){t.primary&&(this.items=kshf.dt[t.tableName],this.itemsSelectedCt=this.items.length)},this),this.layout_infobox.select("div.status_text .info").text("Creating browser..."),this.layout_infobox.select("div.status_text .dynamic").text(""),window.setTimeout(function(){t.loadCharts()},50))},loadCharts:function(){var t=this;if(void 0!==this.loadedCb&&this.loadedCb.call(this),void 0===this.facetDefs){this.facetDefs=[];var i={};this.columnsSkip&&this.columnsSkip.forEach(function(t){i[t]=!0},this);var e=kshf.dt_ColNames_Arr[this.primaryTableName];e.forEach(function(t){t!==this.source.sheets[0].id&&i[t]!==!0&&"*"!==t[0]&&this.facetDefs.push({facetTitle:t})},this)}if(this.facetDefs.forEach(function(i){t.addFacet(i,this.primaryTableName)},this),this.facets.forEach(function(t){t.init_DOM()}),void 0!==this.listDef){this.listDisplay=new kshf.List(this,this.listDef,this.root);var s=this.listDisplay.dom.listHeader_TopRow.append("span").attr("class","resultInfo"),a=this.listDisplay.sortColWidth;"off"!==this.listDisplay.detailsToggle&&(a+=15),this.dom.listheader_count=s.append("span").attr("class","listheader_count").style("width",a+"px").text(0!==this.itemsSelectedCt?this.itemsSelectedCt:"No"),s.append("span").attr("class","listheader_itemName").html(this.itemName),this.listDisplay.hideTextSearch!==!0&&this.listDisplay.insertHeaderTextSearch(),this.dom.filtercrumbs=this.listDisplay.dom.listHeader_BottomRow.append("span").attr("class","filtercrumbs");var r=this.listDisplay.dom.listHeader_TopRow.append("span").attr("class","rightBoxes");if(this.showDataSource!==!1){var n=null;this.source.url?n=r.append("a").attr("class","fa fa-table datasource").attr("href",this.source.url).attr("target","_blank"):this.source.dirPath&&(n=r.append("i").attr("class","fa fa-table datasource")),n&&n.each(function(){this.tipsy=new Tipsy(this,{gravity:"n",title:function(){return"Open Data Source"}})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}).on("click",function(){sendLog&&sendLog(kshf.LOG.DATASOURCE)})}r.append("i").attr("class","fa fa-info-circle credits").each(function(){this.tipsy=new Tipsy(this,{gravity:"n",title:function(){return"Show Info & Credits"}})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}).on("click",function(){t.showInfoBox()})}this.insertClearAll(),this.loaded=!0,this.initBarChartWidth(),this.refreshFilterClearAll(),this.items.forEach(function(t){t.updateWanted()}),this.update(),this.updateLayout_Height(),this.layout_infobox.attr("show","none"),void 0!==this.readyCb&&this.readyCb(this)},addFacet:function(t,i){if(t.catTableName===this.primaryTableName&&(this.listDef.hasLinkedItems=!0),void 0===t.catItemMap)if(void 0!==kshf.dt_ColNames[i]){var e=this.getColumnID(i,t.facetTitle);void 0!==e&&(t.catItemMap=function(t){return t.data[e]})}else kshf.dt[i][0].data[t.facetTitle]&&(t.catItemMap=function(i){return i.data[t.facetTitle]});else"string"==typeof t.catItemMap&&(t.catItemMap=this.getColumnData(i,t.catItemMap));if(t.timeTitle&&(void 0===t.timeItemMap?t.timeItemMap=this.getColumnData(i,t.timeTitle):"string"==typeof t.timeItemMap&&(t.timeItemMap=this.getColumnData(i,t.timeItemMap))),void 0===t.items&&(t.items=this.items),t.type)t.type=t.type.toLowerCase();else if(t.catLabelText||t.timeTitle||t.catTableName)t.type="categorical";else if(t.intervalScale)t.type="interval";else if(void 0!==t.catItemMap){var s=t.catItemMap(kshf.dt[i][0]);t.type="number"==typeof s||s instanceof Date?"interval":"categorical"}else t.type="categorical";void 0===t.catBarScale&&(t.catBarScale=this.options.catBarScale);var a;switch("categorical"===t.type?(void 0!==t.timeTitle&&(t.layout="top"),a=this.addFacet_Categorical(t)):"interval"===t.type&&(a=this.addFacet_Interval(t)),t.layout){case"left":this.facetsLeft.push(a);break;case"right":this.facetsRight.push(a);break;case"top":this.facetsTop.push(a);break;case"bottom":this.facetsBottom.push(a);break;case"bottom-mid":this.facetsBottom.push(a)}return a},addFacet_Categorical:function(t){void 0===t.layout&&(t.layout="left"),void 0===t.sortingOpts&&(t.sortingOpts=[{}]);var i=new kshf.Facet_Categorical(this,t);return this.facets.push(i),i.isLinked&&this.linkedFacets.push(i),i},addFacet_Interval:function(t){void 0===t.layout&&(t.layout="left");var i=new kshf.Facet_Interval(this,t);return this.facets.push(i),i},getColumnID:function(t,i){return void 0===kshf.dt_ColNames[t]?void 0:kshf.dt_ColNames[t][i]},getColumnData:function(t,i){var e=this.getColumnID(t,i);return void 0===e?function(t){return t.data[i]}:function(t){return t.data[e]}},mapItemData:function(t,i,e,s){t.forEach(function(t){var a=i(t);if(t.mappedDataCache[s]=null,void 0!==a&&""!==a&&null!==a){if(a instanceof Array){var r={};if(a=a.filter(function(t){return void 0===t||""===t||null===t?!1:void 0===r[t]?(r[t]=!0,!0):!1}),0===a.length)return}else a=[a];t.mappedDataCache[s]=[];var n=t.mappedDataCache[s];a.forEach(function(i){var s=e[i];void 0!=s&&(n.push(s),s.addItem(t))})}},this)},getWidth_QueryPreview:function(){if(this._labelXOffset)return this._labelXOffset;var t=d3.max(this.facets,function(t){return void 0===t.getMaxBarValueMaxPerAttrib?0:t.getMaxBarValueMaxPerAttrib()});this._labelXOffset=13;for(var i=1;t>9;)i++,t=Math.floor(t/10);return i>4&&(i=4),this._labelXOffset+=6*i,this._labelXOffset},filterFacetAttribute:function(t,i){this.facets[t].filterAttrib(this.facets[t].getAttribs()[i],"OR")},clearFilters_All:function(t){var i=this;this.filterList.forEach(function(t){t.clearFilter(!1)}),t!==!1&&(this.items.forEach(function(t){t.updateWanted_More(!0)}),this.updateItemSelectedCt(),this.refreshFilterClearAll(),this.update(1),sendLog&&sendLog(kshf.LOG.FILTER_CLEAR_ALL)),setTimeout(function(){i.updateLayout_Height()},1e3)},updateItemSelectedCt:function(){this.itemsSelectedCt=0,this.items.forEach(function(t){t.isWanted&&this.itemsSelectedCt++},this)},update:function(t){this.dom.listheader_count.text(0!==this.itemsSelectedCt?this.itemsSelectedCt:"No"),this.facets.forEach(function(i){i.updateAfterFilter(t)}),this.listDisplay&&this.listDisplay.updateAfterFilter(),this.updateCb&&this.updateCb(this)},refreshFilterClearAll:function(){var t=0;this.filterList.forEach(function(i){t+=i.isFiltered?1:0}),this.dom.filterClearAll.style("display",t>0?"inline-block":"none")},clearResultPreview:function(){this.items.forEach(function(t){t.resultDOM&&t.resultDOM.setAttribute("highlight",!1)}),this.facets.forEach(function(t){t.clearResultPreview()})},refreshResultPreview:function(){this.facets.forEach(function(t){t.refreshResultPreview()})},updateLayout:function(){this.loaded===!0&&(this.divWidth=this.domWidth(),this.updateLayout_Height(),this.setBarWidthLeftPanel(this.barChartWidth))},updateLayout_Height:function(){var t=this,i=this.domHeight(),e=i,s=!1,a=!1;this.facets.forEach(function(t){t.heightProcessed=!1});var r=0;if(this.facetsBottom.length>0){var n=e/5;this.facetsBottom.forEach(function(t){t.setHeight(n),t.heightProcessed=!0,r=Math.max(r,t.getHeight_Total()),"bottom"===t.options.layout&&(s=!0,a=!0)})}var o=function(i,e){var s=!1,a=0,r=!1;for(e.forEach(function(t){t.heightProcessed&&a++});;){var n=e.length-a;if(0===n&&10>i)break;var o=a;if(e.forEach(function(e){if(r===!0&&i>5&&!e.collapsed&&void 0!==e.attribCount_Total&&e.attribCount_InDisplay<e.attribCount_Total)return i+=e.getHeight_Total(),e.setHeight(i),i-=e.getHeight_Total(),void 0;if(!e.heightProcessed&&0!==n){var o=Math.floor(i/n);if(s&&o<e.getHeight_RangeMin()&&e.setCollapsed(!0),!e.collapsed)if(e.options.catDispCountFix){var h=e.getHeight_Header()+(e.options.catDispCountFix+1)*t.line_height;if(!s)return;h=Math.max(h,o),e.setHeight(h)}else if(e.getHeight_RangeMax()<=o)e.setHeight(e.getHeight_RangeMax());else if(s)e.setHeight(o);else if(!r)return;i-=e.getHeight_Total(),e.heightProcessed=!0,a++,n--}},this),s=o===a,r===!0)break;0===n&&(r=!0)}return i},h=i;if(this.facetsLeft.length>0){var l=e;s&&(l-=r);var c=o(l,this.facetsLeft);h-=c}if(this.facetsRight.length>0){var d=e;a&&(d-=r),o(d,this.facetsRight)}if(this.facets.forEach(function(t){t.refreshHeight()}),this.listDisplay){var u=0;this.fullWidthResultSet();var f=this.listDisplay.dom.listHeader[0][0].offsetHeight,n=i-u-f;this.facetsBottom.length>0&&(n-=this.facetsBottom[0].getHeight_Total()),this.listDisplay.dom.listItemGroup.style("height",n+"px")}},initBarChartWidth:function(){this.divWidth=this.domWidth();var t;if(this.fullWidthResultSet()&&this.isSmallWidth())t=this.divWidth-this.getWidth_Label()-this.browser.getWidth_QueryPreview()-this.scrollWidth;else if(t=this.barChartWidthInit,void 0===t){var i=this.divWidth-this.categoryTextWidth;this.facetsRight.length>0,i-=this.categoryTextWidth,t=Math.floor(i/10)}this.setBarWidthLeftPanel(t)},setBarWidthLeftPanel:function(t){if(t>200?(this.hideBars=!1,this.hideBarAxis=!1):t>45?(this.hideBars=!1,this.hideBarAxis=!1):t>10?(this.hideBars=!1,this.hideBarAxis=!0):(this.hideBars=!0,this.hideBarAxis=!0,t=0),this.forceHideBarAxis===!0&&(this.hideBarAxis=!0),this.hideBars===!1?this.root.attr("hidebars",!1):this.root.attr("hidebars",!0),this.hideBarAxis===!1?this.root.attr("hideBarAxis",!1):this.root.attr("hideBarAxis",!0),this.barChartWidth=t,this.facets.forEach(function(t){t.hasAttribs&&t.hasAttribs()&&(t.updateBarAxisScale(),t.refreshBarGroupWidth()),t.refreshWidth()},this),this.listDisplay){var i=this.divWidth,e=0,s=0;this.fullWidthResultSet()||(this.facetsLeft.length>0&&(e=2,i-=this.getWidth_LeftPanel()+2),this.facetsRight.length>0&&(s=2,i-=this.getWidth_RightPanel()+2)),this.listDisplay.updateContentWidth(i),this.listDisplay.listDiv.style("width",i+"px"),this.layoutLeft.style("margin-right",e+"px"),this.layoutRight.style("margin-left",s+"px")}},isSmallWidth:function(){return this.leftPanelLabelWidth+260>this.divWidth},fullWidthResultSet:function(){return 0==this.facetsLeft.length&&0==this.facetsRight.length?!0:this.isSmallWidth()?!0:!1},getFilteringState:function(){var t={resultCt:this.itemsSelectedCt};return t.filtered="",t.selected="",this.filterList.forEach(function(i){i.isFiltered&&(""!==t.filtered&&(t.filtered+="x"),t.filtered+=i.id,""!==t.selected&&(t.selected+="x"))},this),""===t.filtered&&(t.filtered=void 0),""===t.selected&&(t.selected=void 0),t}},kshf.Facet_Categorical=function(t,i){this.id=++kshf.num_of_charts,this.browser=t,this.filteredItems=i.items,this.options=i,this.layoutStr=i.layout,this.sortingOpts=i.sortingOpts.slice(),this.parentFacet=i.parentFacet,this.dom={},this.scrollTop_cache=0,this.attrib_InDisplay_First=0,this.configRowCount=0,this.collapsed=!1,i.collapsed===!0&&(this.collapsed=!0),this.skipSorting=!1,this.hasAttribs()&&this.initAttribs(i)},kshf.Facet_Categorical.prototype={getAttribs:function(){return kshf.dt[this.catTableName]},getAttribs_wID:function(){return kshf.dt_id[this.catTableName]},getWidth:function(){return"left"===this.options.layout?this.browser.getWidth_LeftPanel()-this.getWidth_LeftOffset():"right"===this.options.layout?this.browser.getWidth_RightPanel()-this.getWidth_LeftOffset():void 0},getWidth_Header:function(){return"left"===this.options.layout?this.browser.getWidth_LeftPanel()-(void 0!==this.parentFacet?this.getWidth_LeftOffset():0):"right"===this.options.layout?this.browser.getWidth_RightPanel()-(void 0!==this.parentFacet?this.getWidth_LeftOffset():0):void 0},getWidth_Label:function(){var t=0;return"left"===this.options.layout&&(t=this.browser.leftPanelLabelWidth),"right"===this.options.layout&&(t=this.browser.rightPanelLabelWidth),t-=this.getWidth_LeftOffset()},getHeight_Header:function(){return void 0==this._height_header&&(this._height_header=this.dom.headerGroup[0][0].offsetHeight,this.hasFacets()&&(this._height_header+=2)),this._height_header},getHeight_RangeMax:function(){return this.hasAttribs()?this.getHeight_Header()+(this.configRowCount+this.attribCount_Active+1)*this.browser.line_height:this.browser.line_height},getHeight_RangeMin:function(){return this.hasAttribs()?this.getHeight_Header()+(this.configRowCount+Math.min(this.attribCount_Active,3)+1)*this.browser.line_height:this.browser.line_height},getHeight_Total:function(){return this.hasAttribs()?this.collapsed?this.getHeight_Header():this.getHeight_Header()+this.getHeight_Content():this.getHeight_Header()},getHeight_Content:function(){var t=0;return this.allAttribsVisible()&&this.browser.hideBarAxis!==!1||(t=1),this.attribHeight+(this.configRowCount+t)*this.browser.line_height},getWidth_LeftOffset:function(){var t=0;return this.parentFacet?t+=17:this.hasFacets()&&(t+=17),t},isFiltered:function(){return 0!==this.attribFilter.attribCount_Total()||this.attribCount_Wanted!==this.attribCount_Total},allAttribsVisible:function(){return this.attribCount_Active===this.attribCount_InDisplay},hasFacets:function(){return void 0!==this.subFacets},hasAttribs:function(){return void 0!==this.options.catItemMap},initAttribs:function(t){if(this.sortingOpts.forEach(function(t){void 0===t.no_resort&&(t.no_resort=!1),void 0===t.func?t.func=kshf.Util.sortFunc_ActiveCount_TotalCount:t.custom=!0,void 0===t.inverse&&(t.inverse=!1)}),this.sortingOpt_Active=this.sortingOpts[0],void 0===this.options.showNoneCat&&(this.options.showNoneCat=!1),void 0===this.options.removeInactiveAttrib&&(this.options.removeInactiveAttrib=!0),void 0===this.options.catLabelText&&(this.options.catLabelText=function(t){return t.data[1]}),void 0===this.options.catTableName?(this.catTableName=this.options.facetTitle+"_h_"+this.id,this.browser.createTableFromTable(this.filteredItems,this.catTableName,this.options.catItemMap,this.options.attribNameFunc)):(this.options.catTableName===this.browser.primaryTableName&&(this.isLinked=!0,this.options.catTableName=this.options.facetTitle+"_h_"+this.id,kshf.dt_id[this.options.catTableName]=kshf.dt_id[this.browser.primaryTableName],kshf.dt[this.options.catTableName]=this.filteredItems.slice()),this.catTableName=this.options.catTableName),void 0===this.isLinked&&(this.isLinked=!1),this.options.showNoneCat===!0){var i=1e4,e=new kshf.Item([i,"None"],0);kshf.dt[this.catTableName].push(e),kshf.dt_id[this.catTableName][i]=e;var s=this.options.catItemMap;this.options.catItemMap=function(t){var e=s(t);return null===e?i:void 0===e?i:e instanceof Array&&0===e.length?i:e};var a=this.options.catLabelText;if(this.options.catLabelText=function(t){return t.id()===i?"None":a(t)},this.options.catTooltipText){var r=this.options.catTooltipText;this.options.catTooltipText=function(t){return t.id()===i?"None":r(t)}}}this.attribFilter=this.browser.createFilter({name:this.options.facetTitle,browser:this.browser,filteredItems:this.filteredItems,facet:this,onClear:function(){this.clearLabelTextSearch(),this.unselectAllAttribs()},onFilter:this.onAttribFilter,text_header:this.options.textFilter?this.options.textFilter:this.options.facetTitle,text_item:this.text_item_Attrib}),this.attribFilter.attribs_AND=[],this.attribFilter.attribs_OR=[],this.attribFilter.attribs_NOT=[],this.attribFilter.attribCount_Total=function(){return this.attribs_AND.length+this.attribs_OR.length+this.attribs_NOT.length},this.facetFilter=this.attribFilter,this.mapAttribs(t)},insertSubFacets:function(){this.subFacets=[],this.dom.subFacets=this.divRoot.append("div").attr("class","subFacets"),this.dom.subFacets.append("span").attr("class","facetGroupBar").append("span"),this.hasAttribs()?this.options.facets.forEach(function(t){t.parentFacet=this,t.layout=this.layoutStr,t.items=this.getAttribs();var i=this.browser.addFacet(t,this.catTableName);this.subFacets.push(i)},this):this.options.facets.forEach(function(t){t.parentFacet=this,t.layout=this.layoutStr;var i=this.browser.addFacet(t,this.browser.primaryTableName);this.subFacets.push(i)},this),this.subFacets.forEach(function(t){t.init_DOM()})},mapAttribs:function(t){var i=this.attribFilter.id;this.browser.mapItemData(this.filteredItems,this.options.catItemMap,this.getAttribs_wID(),i),this.hasMultiValueItem=!1,this.filteredItems.forEach(function(t){var e=t.mappedDataCache[i];null!==e&&e.length>1&&(this.hasMultiValueItem=!0)},this),this._dataMap=this.options.dataMap?this.isLinked?function(i){return t.dataMap(i)}:function(i){return 0===i.items.length?null:t.dataMap(i)}:this.isLinked?function(t){return t.id()}:function(t){return 0===t.items.length?null:t.id()},this.updateAttribCount_Total(),this.updateAttribCount_Active(),1===this.attribCount_Active&&(this.options.catBarScale="scale_frequency"),this.unselectAllAttribs()},updateAttribCount_Total:function(){this.attribCount_Total=0,this.getAttribs().forEach(function(t){null!==this._dataMap(t)&&this.attribCount_Total++},this),this.attribCount_Wanted=this.attribCount_Total,this.showTextSearch=this.options.forceSearch||this.options.forceSearch!==!1&&this.attribCount_Total>=20},updateAttribCount_Wanted:function(){this.attribCount_Wanted=0,this.getAttribs().forEach(function(t){0!==t.items.length&&t.isWanted&&this.attribCount_Wanted++},this)},updateAttribCount_Active:function(){this.attribCount_Active=0,this.getAttribs().forEach(function(t){null!==this._dataMap(t)&&this.isAttribVisible(t)!==!1&&this.attribCount_Active++},this)},init_DOM:function(){var t,i=this;if(this.parentFacet)t=this.parentFacet.dom.subFacets;else switch(this.options.layout){case"left":t=this.browser.layoutLeft;break;case"right":t=this.browser.layoutRight;break;case"top":t=this.browser.layoutTop;break;case"bottom":t=this.browser.layoutBottom}this.divRoot=t.append("div").attr("class","kshfChart").attr("collapsed",this.collapsed===!1?"false":"true").attr("filtered",!1).attr("removeInactiveAttrib",this.options.removeInactiveAttrib).attr("filtered_or",0).attr("filtered_and",0).attr("filtered_not",0).attr("hasMultiValueItem",this.hasMultiValueItem).on("mouseleave",function(){for(var t=d3.event.toElement;;){if(t===d3.event.fromElement)return;
if(null===t)break;t=t.parentNode}i.skipSorting&&i.hasAttribs()&&(i.skipSorting=!1,setTimeout(function(){i.updateSorting(0)},750)),setTimeout(function(){i.browser.updateLayout_Height()},1500)}),kshf.Util.insertHeader.call(this),this.hasAttribs()&&this.init_DOM_Attrib(),this.options.facets&&(this.divRoot.attr("hasFacets",!0),this.insertSubFacets(),this.refreshLabelWidth())},init_DOM_Attrib:function(){var t=this;this.dom.wrapper=this.divRoot.append("div").attr("class","wrapper"),this.options.facets&&this.dom.wrapper.append("span").attr("class","facetGroupBar").append("span"),this.dom.facetCategorical=this.dom.wrapper.append("div").attr("class","facetCategorical"),this.options.facets&&this.dom.facetCategorical.style("margin-left","17px"),this.dom.facetControls=this.dom.facetCategorical.append("div").attr("class","facetControls"),this.showTextSearch&&(this.insertLabelTextSearch(),this.configRowCount++),this.sortingOpts.length>1&&(this.insertSortingOpts(),this.configRowCount++),this.dom.facetCategorical.append("div").attr("class","scrollToTop").html("⬆").attr("title","Scroll To Top").on("click",function(){kshf.Util.scrollToPos_do(t.dom.attribGroup[0][0],0),sendLog&&sendLog(kshf.LOG.FACET_SCROLL_TOP,{id:t.id})}),this.dom.scrollToTop=this.dom.facetCategorical.selectAll(".scrollToTop"),this.dom.attribGroup=this.dom.facetCategorical.append("div").attr("class","attribGroup").on("scroll",function(){kshf.Util.ignoreScrollEvents!==!0&&(t.dom.scrollToTop.style("visibility",this.scrollTop>0?"visible":"hidden"),t.scrollTop_cache=this.scrollTop,t.attrib_InDisplay_First=Math.floor(this.scrollTop/(1*t.browser.line_height)),t.refreshScrollDisplayMore(t.attrib_InDisplay_First+t.attribCount_InDisplay))}),this.dom.belowAttribs=this.dom.facetCategorical.append("div").attr("class","belowAttribs"),this.dom.belowAttribs.append("div").attr("class","border_line"),this.dom.attribChartAxis=this.dom.belowAttribs.append("div").attr("class","attribChartAxis"),this.dom.attribs=this.dom.attribGroup.selectAll("div.attib").data(this.getAttribs(),function(t){return t.id()}).enter().append("div").attr("class",function(i){var e="attrib";return t.options.domStyle&&(e+=" "+t.options.domStyle.call(this,i)),e}).each(function(i){i.facet=t,i.facetDOM=this,this.isLinked=t.isLinked});var i=this.dom.belowAttribs.append("div").attr("class","hasLabelWidth");this.dom.scroll_display_more=i.append("span").attr("class","scroll_display_more").on("mousedown",function(){kshf.Util.scrollToPos_do(t.dom.attribGroup[0][0],t.dom.attribGroup[0][0].scrollTop+18),sendLog&&sendLog(kshf.LOG.FACET_SCROLL_MORE,{id:t.id})}),this.isLinked&&i.append("span").attr("class","selectAllAttribsButton").on("click",function(){t.selectAllAttribsButton()}),this.insertAttribs()},selectAllAttribsButton:function(){this.getAttribs().forEach(function(t){t.selectedForLink&&t.set_OR(this.attribFilter.attribs_OR)},this),this._update_Selected(),this.attribFilter.how="All",this.attribFilter.addFilter(!0),sendLog&&sendLog(kshf.LOG.FILTER_ATTR_ADD_OR_ALL,{id:this.attribFilter.id})},getMaxTotalItemsPerRow:function(){if(!this._maxTotalItemsPerRow){var t=this._dataMap;this._maxTotalItemsPerRow=d3.max(this.getAttribs(),function(i){return null===t(i)?null:i.items.length})}return this._maxTotalItemsPerRow},getMaxBarValuePerAttrib:function(){return d3.max(this.getAttribs(),function(t){return t.itemCount_Active})},getMaxBarValueMaxPerAttrib:function(){return this._maxBarValueMaxPerAttrib?this._maxBarValueMaxPerAttrib:this.hasAttribs()?(this._maxBarValueMaxPerAttrib=d3.max(this.getAttribs(),function(t){return t.items.length}),this._maxBarValueMaxPerAttrib):0},attrib_UnselectAll:function(){kshf.Util.clearArray(this.attribFilter.attribs_AND),kshf.Util.clearArray(this.attribFilter.attribs_OR),kshf.Util.clearArray(this.attribFilter.attribs_NOT),this._update_Selected()},_update_Selected:function(){this.divRoot&&this.divRoot.attr("filtered",this.isFiltered()).attr("filtered_or",this.attribFilter.attribs_OR.length).attr("filtered_and",this.attribFilter.attribs_AND.length).attr("filtered_not",this.attribFilter.attribs_NOT.length),this.attribFilter.attribs_OR.forEach(function(t){t.facetDOM.setAttribute("show-box",this.attribFilter.attribs_OR.length>1)},this),this.attribFilter.attribs_AND.forEach(function(t){t.facetDOM.setAttribute("show-box",this.attribFilter.attribs_AND.length>1)},this),this.attribFilter.attribs_NOT.forEach(function(t){t.facetDOM.setAttribute("show-box","true")},this)},unselectAllAttribs:function(){this.getAttribs().forEach(function(t){t.f_selected()&&t.facetDOM&&t.facetDOM.setAttribute("highlight",!1),t.set_NONE()}),this.attrib_UnselectAll()},setCollapsed:function(t){this.collapsed=t,this.divRoot.attr("collapsed",this.collapsed===!1?"false":"true"),this.hasFacets()&&!this.hasAttribs()&&this.subFacets.forEach(function(i){i.setCollapsed(t)})},collapseFacet:function(t){this.setCollapsed(t),this.browser.updateLayout_Height(),sendLog&&sendLog(t===!0?kshf.LOG.FACET_COLLAPSE:kshf.LOG.FACET_SHOW,{id:this.id})},insertLabelTextSearch:function(){var t=this,i=this.dom.facetControls.append("div").attr("class","attribTextSearch hasLabelWidth");this.dom.attribTextSearch=i.append("input").attr("type","text").attr("placeholder","Search").on("input",function(){this.timer&&clearTimeout(this.timer);var e=this;this.timer=setTimeout(function(){var s=e.value.toLowerCase();""===s?t.attribFilter.clearFilter(!0):(i.select(".clearText").style("display","block"),t.attrib_UnselectAll(),t.getAttribs().forEach(function(i){-1!==t.options.catLabelText(i).toString().toLowerCase().indexOf(s)?i.set_OR(t.attribFilter.attribs_OR):t.options.catTooltipText&&-1!==t.options.catTooltipText(i).toLowerCase().indexOf(s)?i.set_OR(t.attribFilter.attribs_OR):i.set_NONE(),i.is_OR()&&t._update_Selected()}),t.isFiltered()?(t.attribFilter.how="All",t.attribFilter.addFilter(!0),sendLog&&sendLog(kshf.LOG.FILTER_TEXTSEARCH,{id:t.attribFilter.id,info:s})):t.attribFilter.clearFilter(!0))},750)}).on("blur",function(){d3.event.stopPropagation(),d3.event.preventDefault()}),i.append("i").attr("class","fa fa-search searchIcon"),this.dom.clearTextSearch=i.append("i").attr("class","fa fa-times-circle clearText").on("click",function(){t.attribFilter.clearFilter(!0)})},clearLabelTextSearch:function(){this.showTextSearch&&(this.dom.clearTextSearch.style("display","none"),this.dom.attribTextSearch[0][0].value="")},insertSortingOpts:function(){var t=this,i=this.dom.facetControls.append("span").attr("class","sortOptionSelectGroup hasLabelWidth");i.append("span").attr("class","optionSelect_Label").text("Order by"),i.append("select").attr("class","optionSelect").on("change",function(){t.sortingOpt_Active=t.sortingOpts[this.selectedIndex],t.updateSorting_do.call(t,0),sendLog&&sendLog(kshf.LOG.FACET_SORT,{id:t.id,info:this.selectedIndex})}).selectAll("input.sort_label").data(this.sortingOpts).enter().append("option").attr("class","sort_label").text(function(t){return t.name})},updateBarAxisScale:function(){if(this.hasAttribs()){var t=this;this.catBarAxisScale=d3.scale.linear().rangeRound([0,this.browser.barChartWidth]).nice(this.getTicksSkip()).clamp(!0),"scale_frequency"===this.options.catBarScale?this.catBarAxisScale.domain([0,this.browser.itemsSelectedCt]):this.catBarAxisScale.domain([0,this.getMaxBarValuePerAttrib()]),this.refreshWidth_Bars_Active(),this.refreshWidth_Bars_Total(),this.dom.bar_highlight.attr("fast",null),this.refreshResultPreview(),setTimeout(function(){t.dom.bar_highlight.attr("fast",!0)},700),this.refresh_Bars_Ticks()}},setHeight:function(t){if(this.hasAttribs()){var i=t-this.getHeight_Header()-(1+this.configRowCount)*this.browser.line_height;this.attribHeight=Math.min(i,this.browser.line_height*this.attribCount_Active),i=Math.floor(i/this.browser.line_height),0>i&&(i=1),i>this.attribCount_Active&&(i=this.attribCount_Active),i=this.attribCount_Active<=2?this.attribCount_Active:Math.max(i,2),this.attribCount_InDisplay=i,this.refreshScrollDisplayMore(this.attribCount_InDisplay)}},updateAfterFilter:function(){this.hasAttribs()&&(this.refreshActiveItemCount(),this.updateBarAxisScale(),this.skipSorting?this.refreshWidth_Bars_Active():this.updateSorting())},refreshWidth:function(){this.dom.facetCategorical&&this.dom.facetCategorical.style("width",this.getWidth()+"px")},refreshActiveItemCount:function(){var t=this,i=kshf.Util.formatForItemCount;this.dom.item_count.text(function(t){return i(t.itemCount_Active)}),this.dom.attribs.attr("noitems",function(i){return!t.isAttribSelectable(i)}).attr("itemCount_Active",function(t){return t.itemCount_Active})},refreshBarGroupWidth:function(){this.dom.barGroup.style("width",this.browser.barChartWidth+"px")},refreshWidth_Bars_Active:function(){var t=this;this.dom.bar_active.each(function(i){kshf.Util.setTransform(this,"scaleX("+t.catBarAxisScale(i.itemCount_Active)+")")});var i=this.getWidth_Label()+this.browser.getWidth_QueryPreview();this.dom.attribClickArea.style("width",function(e){return i+t.catBarAxisScale(e.itemCount_Active)+"px"})},refreshWidth_Bars_Total:function(){var t=this;this.dom.bar_total.each(function(i){kshf.Util.setTransform(this,"scaleX("+t.catBarAxisScale(i.items.length)+")")})},clearResultPreview:function(){if(this.hasAttribs()&&!this.collapsed){var t=this;this.dom.bar_highlight.each(function(i){if(i.itemCount_Preview=0,!(i.orderIndex<t.attrib_InDisplay_First||i.orderIndex>t.attrib_InDisplay_First+t.attribCount_InDisplay+3)){var e="scaleX(0)";kshf.Util.setTransform(this,e)}})}},refreshResultPreview:function(){if(this.hasAttribs()&&!this.collapsed){var t=this;this.dom.bar_highlight.each(function(i){if(!(i.orderIndex<t.attrib_InDisplay_First||i.orderIndex>t.attrib_InDisplay_First+t.attribCount_InDisplay+1)){var e="scaleX("+t.catBarAxisScale(i.itemCount_Preview)+")";kshf.Util.setTransform(this,e)}})}},refreshLabelWidth:function(){var t=this.browser,i=this.getWidth_Label(),e=this.getWidth_LeftOffset(),s=i;this.hasFacets()&&(s+=e),this.hasAttribs()&&(this.dom.facetCategorical.selectAll(".hasLabelWidth").style("width",i+"px"),this.dom.attribChartAxis.each(function(){var e=i+t.getWidth_QueryPreview();kshf.Util.setTransform(this,"translateX("+e+"px)")}))},refreshScrollDisplayMore:function(t){var i=this.attribCount_Active+" total",e=this.attribCount_Active-t;e>0&&(i+=" / "+e+" more..."),this.dom.scroll_display_more.text(i)},refreshHeight:function(){this.hasAttribs()&&(this.dom.wrapper.style("height",(this.collapsed?"0":this.getHeight_Content())+"px"),this.dom.attribGroup.style("height",this.attribHeight+"px"),this.dom.attribChartAxis.selectAll("span.line").style("top","-"+(this.attribHeight-8)+"px").style("height",this.attribHeight-8+"px"))},onAttribFilter:function(t){if(this.isFiltered()){var i=t.id;this.filteredItems.forEach(function(e){var s=e.mappedDataCache[i];if(null===s)return t.attribs_AND.length>0||t.attribs_OR.length>0?(e.setFilter(i,!1),void 0):(e.setFilter(i,!0),void 0);if(t.attribs_NOT.length>0&&!s.every(function(t){return!t.is_NOT()}))return e.setFilter(i,!1),void 0;if(t.attribs_OR.length>0&&s.some(function(t){return t.is_OR()}))return e.setFilter(i,!0),void 0;if(t.attribs_AND.length>0){var a=0;if(s.forEach(function(t){t.is_AND()&&a++}),a!==t.attribs_AND.length)return e.setFilter(i,!1),void 0;e.setFilter(i,!0)}return t.attribs_OR.length>0?(e.setFilter(i,!1),void 0):(e.setFilter(i,!0),void 0)},this)}},isAttribVisible:function(t){return this.isLinked?t.selectedForLink===!1?!1:!0:t.f_selected()?!0:0!==t.itemCount_Active?!0:this.attribCount_Wanted<this.attribCount_Total&&t.isWanted?!0:this.options.removeInactiveAttrib===!1?!0:this.isFiltered()?t.isWanted===!1?!1:!0:0!==t.itemCount_Active},isAttribSelectable:function(t){return t.f_selected()?!0:0!==t.itemCount_Active?!0:this.isFiltered()&&!this.hasMultiValueItem?!0:!1},filterAttrib:function(t,i,e){this.skipSorting=!0;var s=this.attribFilter.attribs_OR.length>0&&(this.attribFilter.attribs_AND.length>0||this.attribFilter.attribs_NOT.length>0);if("NOT"===i&&t.is_NOT()&&(i="NONE"),"AND"===i&&t.is_AND()&&(i="NONE"),"OR"===i&&t.is_OR()&&(i="NONE"),"NONE"===i&&((t.is_AND()||t.is_NOT())&&(this.attribFilter.how="MoreResults"),t.is_OR()&&(this.attribFilter.how=0===this.attribFilter.attribs_OR.length?"MoreResults":"LessResults"),t.set_NONE(),sendLog&&sendLog(kshf.LOG.FILTER_ATTR_UNSELECT,{id:this.attribFilter.id,info:t.id()})),"NOT"===i){if(t.is_NONE()){if(t.itemCount_Active===this.browser.itemsSelectedCt)return alert("Removing this attribute would make an empty result set, so it is not allowed."),void 0;this.attribFilter.how="LessResults"}else this.attribFilter.how="All";t.set_NOT(this.attribFilter.attribs_NOT),sendLog&&sendLog(kshf.LOG.FILTER_ATTR_ADD_NOT,{id:this.attribFilter.id,info:t.id()})}if("AND"===i&&(t.set_AND(this.attribFilter.attribs_AND),this.attribFilter.how="LessResults",sendLog&&sendLog(kshf.LOG.FILTER_ATTR_ADD_AND,{id:this.attribFilter.id,info:t.id()})),"OR"===i){if(!this.hasMultiValueItem){var a=[];this.attribFilter.attribs_NOT.forEach(function(t){a.push(t)}),a.forEach(function(t){t.set_NONE()})}t.set_OR(this.attribFilter.attribs_OR),this.attribFilter.how=1===this.attribFilter.attribs_OR.length?"LessResults":"MoreResults",sendLog&&sendLog(kshf.LOG.FILTER_ATTR_ADD_OR,{id:this.attribFilter.id,info:t.id()})}return e&&(this.attribFilter.how=e),s&&(this.attribFilter.how="All"),this.attribFilter.attribs_OR.length>0&&(this.attribFilter.attribs_AND.length>0||this.attribFilter.attribs_NOT.length>0)&&(this.attribFilter.how="All"),this._update_Selected(),this.isFiltered()?(this.clearLabelTextSearch(),this.attribFilter.addFilter(!0),void 0):(this.attribFilter.clearFilter(!0),void 0)},text_item_Attrib:function(){var t="",i=this.options.catLabelText;this.options.catTooltipText;var e=(this.attribFilter.attribs_AND.length>0||this.attribFilter.attribs_NOT.length>0)&&this.attribFilter.attribs_OR.length>0,s=this.attribFilter.attribs_AND.length+this.attribFilter.attribs_OR.length+this.attribFilter.attribs_NOT.length;if(s>4)return"<b>"+s+"</b> selections";var a=0;return e&&(t+="[ "),this.attribFilter.attribs_AND.forEach(function(e){t+=(0!==a?" and ":"")+"<b>"+i(e)+"</b>",a++}),this.attribFilter.attribs_NOT.forEach(function(e){t+=(0!==a?" and ":"")+"not <b>"+i(e)+"</b>",a++}),e&&(t+=" ]"),this.attribFilter.attribs_OR.forEach(function(e){t+=(0!==a?" or ":"")+"<b>"+i(e)+"</b>",a++}),t},insertAttribs:function(){var t=this;this.browser;var i=null,e=function(i){if(t.isAttribSelectable(i)){if(i.facetDOM.tipsy_active&&i.facetDOM.tipsy_active.hide(),this.timer)return t.unselectAllAttribs(),t.filterAttrib(i,t.hasMultiValueItem?"AND":"OR","All"),sendLog&&sendLog(kshf.LOG.FILTER_ATTR_EXACT,{id:t.attribFilter.id,info:i.id()}),void 0;if(i.is_NOT())t.filterAttrib(i,"NOT");else if(i.is_AND())t.filterAttrib(i,"AND");else if(i.is_OR())t.filterAttrib(i,"OR");else if(!t.hasMultiValueItem&&t.attribFilter.attribs_OR.length>0){if(t.attribFilter.attribs_OR.indexOf(i)<0){var e=[];t.attribFilter.attribs_OR.forEach(function(t){e.push(t)}),e.forEach(function(t){t.set_NONE()})}t.filterAttrib(i,"OR","All")}else t.filterAttrib(i,t.hasMultiValueItem?"AND":"OR");var s=this;this.timer=setTimeout(function(){s.timer=null},500)}},s=function(e){if(t.tipsy_active&&t.tipsy_active.hide(),t.isAttribSelectable(e))e.facetDOM.setAttribute("selectType",t.hasMultiValueItem?"and":"or"),t.browser.pauseResultPreview||(e.items.forEach(function(i){i.updatePreview(t)},this),e.highlightAll(t,!0),t.browser.refreshResultPreview(),sendLog&&(i&&clearTimeout(i),i=setTimeout(function(){sendLog(kshf.LOG.FILTER_PREVIEW,{id:t.attribFilter.id,info:e.id()})},1e3)));else if(void 0===this.tipsy_title)return;e.facetDOM.tipsy_active=e.facetDOM.tipsy,t.tipsy_active=e.facetDOM.tipsy,e.facetDOM.tipsy_active.options.offset_x=t.browser.hideBars?0:t.catBarAxisScale(e.itemCount_Active)-t.catBarAxisScale.range()[1],e.facetDOM.tipsy_active.show()},a=function(e){return void 0!==e.skipMouseOut&&e.skipMouseOut===!0?(e.skipMouseOut=!1,void 0):(t.isAttribSelectable(e)&&(e.nohighlightAll(t,!0),i&&clearTimeout(i),t.browser.pauseResultPreview||t.browser.clearResultPreview(),e.facetDOM.tipsy_active&&e.facetDOM.tipsy_active.hide()),void 0)};this.dom.attribs.attr("highlight","false").attr("selected","0").each(function(i){kshf.Util.setTransform(this,"translateY(0px)"),this.tipsy=new Tipsy(this,{gravity:"w",offset_x:2,offset_y:-1,title:function(){if(this.tipsy_title)return this.tipsy_title;t.options.facetTitle;var e=i.facet.hasMultiValueItem;return i.is_AND()||i.is_OR()||i.is_NOT()?"<span class='fa fa-times'></span> <span class='action'>Remove</span> from filter":0===t.attribFilter.attribs_OR.length&&0===t.attribFilter.attribs_AND.length?"<span class='fa fa-plus'></span> <span class='action'>Add</span> filter":e===!1?"<span class='fa fa-angle-double-left'></span> <span class='action'>Change</span> filter":"<span class='fa fa-plus'></span> <span class='action'>And ...</span>"}})}),this.options.catTooltipText&&this.dom.attribs.attr("title",function(i){return t.options.catTooltipText.call(this,i)}),this.dom.attribClickArea=this.dom.attribs.append("span").attr("class","clickArea").on("click",e).on("mouseenter",s).on("mouseleave",a);var r=this.dom.attribClickArea.append("span").attr("class","filterButtons");r.append("span").attr("class","orButton fa fa-plus-square").on("mouseenter",function(i){var e=i.facetDOM;e.tipsy_title="<span class='fa fa-plus'></span> <span class='action'>Or ...</span>",e.tipsy.hide(),i.facetDOM.tipsy_active=i.facetDOM.tipsy,t.tipsy_active=i.facetDOM.tipsy,i.facetDOM.tipsy_active.options.offset_x=t.browser.hideBars?0:t.catBarAxisScale(i.itemCount_Active)-t.catBarAxisScale.range()[1],i.facetDOM.tipsy_active.show(),e.tipsy.show(),t.tipsy_active=e.tipsy,t.attribFilter.attribs_OR.length>0&&t.browser.clearResultPreview(),i.facetDOM.setAttribute("selectType","or"),d3.event.stopPropagation()}).on("mouseout",function(i){this.__data__.facetDOM.tipsy_title=void 0,this.__data__.facetDOM.tipsy.hide(),this.__data__.facetDOM.tipsy.show(),t.tipsy_active=this.__data__.facetDOM.tipsy,i.facetDOM.setAttribute("selectType",t.hasMultiValueItem?"and":"or"),d3.event.stopPropagation()}).on("click",function(i){t.filterAttrib(i,"OR"),this.__data__.facetDOM.tipsy.hide(),d3.event.stopPropagation()}),r.append("span").attr("class","notButton fa fa-minus-square").on("mouseover",function(i){this.__data__.facetDOM.tipsy_title="<span class='fa fa-minus'></span> <span class='action'>Not ...</span>",this.__data__.facetDOM.tipsy.hide(),this.__data__.facetDOM.tipsy.show(),i.facetDOM.setAttribute("selectType","not"),t.tipsy_active=this.__data__.facetDOM.tipsy,d3.event.stopPropagation()}).on("mouseout",function(i){this.__data__.facetDOM.tipsy_title=void 0,this.__data__.facetDOM.tipsy.hide(),this.__data__.facetDOM.tipsy.show(),t.tipsy_active=this.__data__.facetDOM.tipsy,i.facetDOM.setAttribute("selectType",t.hasMultiValueItem?"and":"or"),d3.event.stopPropagation()}).on("click",function(i){t.filterAttrib(i,"NOT"),this.__data__.facetDOM.tipsy.hide(),d3.event.stopPropagation()}),this.dom.attrLabel=this.dom.attribs.append("span").attr("class","attribLabel hasLabelWidth"),this.dom.filterButtons=this.dom.attrLabel.append("span").attr("class","filterButtons"),this.dom.filterButtons.append("span").attr("class","orButton fa fa-plus-square"),this.dom.filterButtons.append("span").attr("class","notButton fa fa-minus-square"),this.dom.attrLabel.append("span").attr("class","theLabel").html(this.options.catLabelText),this.dom.item_count_wrapper=this.dom.attribs.append("span").attr("class","item_count_wrapper").style("width",this.browser.getWidth_QueryPreview()+"px"),this.dom.item_count=this.dom.item_count_wrapper.append("span").attr("class","item_count"),this.dom.barGroup=this.dom.attribs.append("span").attr("class","barGroup"),this.dom.bar_total=this.dom.barGroup.append("span").attr("class",function(i,e){return"bar total "+(t.options.barClassFunc?t.options.barClassFunc(i,e):"")}),this.dom.bar_active=this.dom.barGroup.append("span").attr("class",function(i,e){return"bar active "+(t.options.barClassFunc?t.options.barClassFunc(i,e):"")}),this.dom.bar_highlight=this.dom.barGroup.append("span").attr("class","bar hover").attr("fast",!0),this.dom.allRowBars=this.dom.attribs.selectAll("span.bar"),this.refreshLabelWidth(),this.updateSorting(void 0,!0)},sortAttribs:function(){void 0===this.sortingOpt_Active&&(this.sortingOpt_Active=this.sortingOpts[0]);var t=this.sortingOpt_Active.no_resort!==!0,i=this.sortingOpt_Active.inverse,e=this.sortingOpt_Active.func,s=function(t,i){return i-t};"string"==typeof this.getAttribs()[0].id()&&(s=function(t,i){return i.localeCompare(t)});var a=function(a,r){if(a.selectedForLink&&!r.selectedForLink)return-1;if(r.selectedForLink&&!a.selectedForLink)return 1;if(t){if(!a.f_selected()&&r.f_selected())return 1;if(a.f_selected()&&!r.f_selected())return-1}if(0===a.itemCount_Active&&0!==r.itemCount_Active)return 1;if(0===r.itemCount_Active&&0!==a.itemCount_Active)return-1;var n=e(a,r);return 0===n&&(n=s(a.id(),r.id())),i&&(n=-n),n};this.getAttribs().sort(a),this.getAttribs().forEach(function(t,i){t.orderIndex=i})},updateSorting:function(t,i){void 0===this.sortingOpt_Active&&(this.sortingOpt_Active=this.sortingOpts[0]),(this.sortingOpt_Active.custom!==!0||i===!0)&&(this.options.removeInactiveAttrib&&this.updateAttribCount_Active(),this.refreshScrollDisplayMore(this.attribCount_InDisplay),this.updateSorting_do(t))},updateSorting_do:function(t){var i=this.browser.line_height,e=this;void 0===t&&(t=1e3),this.sortAttribs(),setTimeout(function(){e.dom.attribs.each(function(t){var s=e.isAttribVisible(t);if(this.style.display=s?"block":"none",s){var a=t.orderIndex,r="translateY("+i*a+"px)";kshf.Util.setTransform(this,r)}})},t);var s=e.dom.attribGroup[0][0];0!==this.scrollTop_cache&&kshf.Util.scrollToPos_do(s,0)},getTicksSkip:function(){var t=this.browser.barChartWidth/25;return this.getMaxBarValuePerAttrib()>1e5&&(t=this.browser.barChartWidth/30),t},refresh_Bars_Ticks:function(){var t=this,i=this.attribHeight,e=this.catBarAxisScale.ticks(this.getTicksSkip());e=e.filter(function(t){return 0===t%1});var s=this.dom.attribChartAxis.selectAll("span.tick").data(e,function(t){return t}),a=this.browser.root.attr("noanim");"true"!==a&&this.browser.root.attr("noanim",!0);var r=function(i){var e=t.catBarAxisScale(i),s="translateX("+e+"px)";kshf.Util.setTransform(this,s)},n=s.enter().append("span").attr("class","tick").each(r);"true"!==a&&this.browser.root.attr("noanim",!1),n.append("span").attr("class","line").style("top","-"+i+"px").style("height",i+"px"),n.append("span").attr("class","text").text(function(t){return d3.format("s")(t)}),setTimeout(function(){t.dom.attribChartAxis.selectAll("span.tick").style("opacity",1).each(r)}),s.exit().remove()}},kshf.Facet_Interval=function(t,i){var e=this;this.id=++kshf.num_of_charts,this.browser=t,this.filteredItems=i.items,this.options=i,this.layoutStr=i.layout,this.parentFacet=i.parentFacet,this.height_hist=65,this.height_hist_min=30,this.height_hist_max=100,this.height_slider=10,this.height_labels=16,this.height_bin_top=19,this.height_percentile=0,this.barGap=2,this.histogramMargin=12,this.dom={},this.collapsed=!1,i.collapsed===!0&&(this.collapsed=!0),void 0===i.optimumTickWidth&&(i.optimumTickWidth=40),void 0===i.intervalScale&&(i.intervalScale="linear"),i.showPercentile===!0&&(this.height_percentile=14),this.tickIntegerOnly=!1,i.tickIntegerOnly===!0&&(this.tickIntegerOnly=!0),this.barHeightScale=d3.scale.linear(),this.intervalFilter=t.createFilter({name:this.options.facetTitle,browser:this.browser,filteredItems:this.filteredItems,facet:this,onClear:function(){this.divRoot.attr("filtered",!1),this.resetIntervalFilterActive(),this.refreshIntervalSlider()},onFilter:function(t){"true"!==this.divRoot.attr("filtered")&&this.divRoot.attr("filtered",!0);var i=t.active.min,s=t.active.max;t.max_inclusive||(s-=.01);var a;a=e.isFiltered_min()&&e.isFiltered_max()?function(t){return t>=i&&s>=t}:e.isFiltered_min()?function(t){return t>=i}:function(t){return s>=t},t.filteredItems.forEach(function(i){var e=i.mappedDataCache[t.id].v;null===e?i.setFilter(t.id,!1):i.setFilter(t.id,a(e))},this),this.refreshIntervalSlider()},text_header:this.options.facetTitle,text_item:function(t){return"step"===this.options.intervalScale&&t.active.min+1===t.active.max?"<b>"+t.active.min+"</b>":"time"===this.options.intervalScale?"<b>"+this.intervalTickFormat(t.active.min)+"</b> to <b>"+this.intervalTickFormat(t.active.max)+"</b>":e.isFiltered_min()&&e.isFiltered_max()?"<b>"+t.active.min+"</b> to <b>"+t.active.max+"</b>":e.isFiltered_min()?"at least <b>"+t.active.min+"</b>":"at most <b>"+t.active.max+"</b>"}}),this.intervalFilter.how="All",this.facetFilter=this.intervalFilter;var s=this.intervalFilter.id;this.hasFloat=!1,this.filteredItems.forEach(function(t){var i=this.options.catItemMap(t);null!==i&&(i instanceof Date?this.hasTime=!0:"number"!=typeof i?i=null:this.hasFloat||(this.hasFloat=this.hasFloat||0!==i%1)),t.mappedDataCache[s]={v:i,h:this}},this);var a=function(t){return t.mappedDataCache[s].v},r="log"===this.options.intervalScale;return this.filteredItems=this.filteredItems.filter(function(t){var i=a(t);return null===i?!1:void 0===i?!1:r&&0===i?!1:!0}),this.filteredItems.sort(function(t,i){var e=a(t),s=a(i);return e.getTime&&(e=e.getTime()),s.getTime&&(s=s.getTime()),e-s}),this.intervalRange={min:d3.min(this.filteredItems,a),max:d3.max(this.filteredItems,a)},"step"===this.options.intervalScale&&this.intervalRange.max++,void 0===this.intervalRange.min?(this.isEmpty=!0,void 0):(this.isEmpty=!1,this.resetIntervalFilterActive(),void 0)},kshf.Facet_Interval.prototype={getWidth:function(){return"left"===this.options.layout?this.browser.getWidth_LeftPanel()-this.getWidth_Offset():"right"===this.options.layout?this.browser.getWidth_RightPanel()-this.getWidth_Offset():"bottom"===this.options.layout?this.browser.getWidth_Total()-this.getWidth_Offset():"bottom-mid"===this.options.layout?this.browser.getWidth_MidPanel():void 0},getWidth_Offset:function(){return this.parentFacet?17:0},getHeight_Header:function(){return void 0==this._height_header&&(this._height_header=this.dom.headerGroup[0][0].offsetHeight),this._height_header},getHeight_Extra:function(){return this.height_bin_top+this.height_labels+this.height_slider+this.height_percentile},getHeight_Total:function(){return this.collapsed?this.getHeight_Header():this.getHeight_Header()+this.height_hist+this.getHeight_Extra()},getHeight_RangeMax:function(){return this.getHeight_Header()+this.height_hist_max+this.getHeight_Extra()},getHeight_RangeMin:function(){return this.getHeight_Header()+this.height_hist_min+this.getHeight_Extra()},isFiltered:function(){return this.intervalFilter.active.min!==this.intervalRange.min||this.intervalFilter.active.max!==this.intervalRange.max},isFiltered_min:function(){return this.intervalFilter.active.min!==this.intervalRange.min},isFiltered_max:function(){return this.intervalFilter.active.max!==this.intervalRange.max},resetIntervalFilterActive:function(){this.intervalFilter.active={min:this.intervalRange.min,max:this.intervalRange.max}},getMaxBinTotalItems:function(){return d3.max(this.histBins,function(t){return t.length})},getMaxBinActiveItems:function(){return d3.max(this.histBins,function(t){return t.itemCount_Active})},init_DOM:function(){var t=this;this.browser;var i;if(this.parentFacet)i=this.parentFacet.dom.subFacets;else switch(this.options.layout){case"left":i=this.browser.layoutLeft;break;case"right":i=this.browser.layoutRight;break;case"top":i=this.browser.layoutTop;break;case"bottom":i=this.browser.layoutBottom;break;case"bottom-mid":i=this.browser.layoutBottom}this.divRoot=i.append("div").attr("class","kshfChart").attr("collapsed",this.collapsed===!1?"false":"true").attr("filtered",!1),kshf.Util.insertHeader.call(this),this.dom.wrapper=this.divRoot.append("div").attr("class","wrapper"),this.dom.facetInterval=this.dom.wrapper.append("div").attr("class","facetInterval"),this.dom.histogram=this.dom.facetInterval.append("div").attr("class","histogram"),this.dom.histogram_bins=this.dom.histogram.append("div").attr("class","bins"),this.dom.intervalSlider=this.dom.facetInterval.append("div").attr("class","intervalSlider rangeSlider").attr("anim",!0),this.insertSlider(),this.dom.selectedItemValue=this.dom.intervalSlider.select(".selectedItemValue"),this.dom.labelGroup=this.dom.facetInterval.append("div").attr("class","labelGroup"),this.options.showPercentile===!0&&(this.dom.percentileGroup=this.dom.facetInterval.append("div").attr("class","percentileGroup"),this.dom.percentileGroup.append("span").attr("class","percentileTitle").html("Percentiles"),this.dom.quantile={},[[10,90],[20,80],[30,70],[40,60]].forEach(function(i){this.dom.quantile[""+i[0]+"_"+i[1]]=this.dom.percentileGroup.append("span").attr("class","quantile q_range q_"+i[0]+"_"+i[1]).each(function(){this.tipsy=new Tipsy(this,{gravity:"s",title:function(){return"<span style='font-weight:300'>%"+i[0]+" - %"+i[1]+" Percentile: <span style='font-weight:500'>"+t.quantile_val[i[0]]+" - "+t.quantile_val[i[1]]+"</span></span>"}})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()})},this),[10,20,30,40,50,60,70,80,90].forEach(function(i){this.dom.quantile[i]=this.dom.percentileGroup.append("span").attr("class","quantile q_pos q_"+i).each(function(){this.tipsy=new Tipsy(this,{gravity:"s",title:function(){return"Median: "+t.quantile_val[i]}})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()})},this))},updateIntervalWidth:function(t){if(!this.isEmpty&&(void 0===this.intervalRange.width||this.intervalRange.width!==t)){switch(this.intervalRange.width=t,this.optimalTickCount=Math.floor(this.intervalRange.width/this.options.optimumTickWidth),this.options.intervalScale){case"linear":case"step":this.intervalScale=d3.scale.linear();break;case"log":this.intervalScale=d3.scale.log().base(2);break;case"time":this.intervalScale=d3.time.scale.utc()}this.intervalScale.domain([this.intervalRange.min,this.intervalRange.max]).range([0,this.intervalRange.width]).nice(this.optimalTickCount).clamp(!0);var i=this.intervalScale.ticks(this.optimalTickCount);if(this.tickIntegerOnly&&(i=i.filter(function(t){return 0===t%1})),"time"===this.options.intervalScale)this.intervalTickFormat=this.intervalScale.tickFormat(this.optimalTickCount);else if("log"===this.options.intervalScale)for(this.intervalTickFormat=d3.format(".1s");i.length>2*this.optimalTickCount;)i=i.filter(function(t,i){return 0===i%2});else if("step"===this.options.intervalScale){var e=this.intervalRange.max-this.intervalRange.min+1;i=new Array(e);for(var s=0;e>s;s++)i[s]=this.intervalRange.min+s;this.intervalTickFormat=d3.format("d")}else this.intervalTickFormat=d3.format(this.tickIntegerOnly?"s":".2s");void 0===this.intervalTicks||this.intervalTicks.length!==i.length?this.updateTicks(i):(this.barWidth=this.intervalRange.width/(1*(i.length-1)),this.refreshBins_Translate(),this.refreshBars_Active_Scale(),this.refreshBars_Total_Scale(),this.refreshAxisLabelPos()),this.refreshIntervalSlider()}},updateTicks:function(t){this.intervalTicks=t;var i=this.intervalFilter.id,e=function(t){return t.mappedDataCache[i].v};this.histBins=d3.layout.histogram().bins(this.intervalTicks).value(e)(this.filteredItems);var s=this.intervalScale(t[0]),a=this.intervalScale(t[1]);this.barWidth=a-s,this.updateActiveItems(),this.updateBarScale2Active(),this.insertBins(),this.insertAxisLabels()},insertBins:function(){var t=this,i=null,e=this.intervalFilter.id,s=this.dom.histogram_bins.selectAll("span.bar").data(this.histBins,function(t,i){return i});s.exit().remove();var a=s.enter().append("span").attr("class","bin").each(function(t){t.itemCount_Preview=0,t.forEach(function(i){i.mappedDataCache[e].b=t},this)}),r=function(e){t.browser.pauseResultPreview||(this.parentNode.setAttribute("highlight","selected"),e.forEach(function(i){i.updatePreview(t)}),t.browser.refreshResultPreview(),sendLog&&(i&&clearTimeout(i),i=setTimeout(function(){sendLog(kshf.LOG.FILTER_PREVIEW,{id:t.intervalFilter.id,info:e.x+"x"+e.dx})
},1e3)))},n=function(){i&&clearTimeout(i),t.browser.pauseResultPreview||(this.parentNode.setAttribute("highlight",!1),t.browser.clearResultPreview())},o=function(i){return"true"===this.parentNode.getAttribute("filtered")?(this.parentNode.setAttribute("filtered",!1),t.intervalFilter.clearFilter(!0),void 0):(this.parentNode.setAttribute("filtered","true"),t.intervalFilter.dom_HistogramBar=this,t.intervalFilter.active="time"!==t.options.intervalScale?{min:i.x,max:i.x+i.dx}:{min:i.x,max:new Date(i.x.getTime()+i.dx)},t.intervalFilter.max_inclusive=i.x+i.dx===t.intervalRange.max,t.intervalFilter.addFilter(!0),sendLog&&sendLog(kshf.LOG.FILTER_INTRVL_BIN,{id:t.intervalFilter.id,info:t.intervalFilter.active.min+"x"+t.intervalFilter.active.max}),void 0)};a.append("span").attr("class","bar total"),a.append("span").attr("class","bar active").on("mouseover",r).on("mouseout",n).on("click",o),a.append("span").attr("class","bar hover").attr("fast",!0),a.append("span").attr("class","item_count").on("mouseover",r).on("mouseout",n).on("click",o),this.dom.histogram_bin=this.dom.histogram_bins.selectAll("span.bin"),this.dom.bars_active=this.dom.histogram_bin.selectAll(".bar.active"),this.dom.bars_total=this.dom.histogram_bin.selectAll(".bar.total"),this.dom.bars_highlight=this.dom.histogram_bin.selectAll(".bar.hover"),this.dom.bars_item_count=this.dom.histogram_bin.selectAll(".item_count"),this.refreshBins_Translate(),this.refreshBars_Total_Scale(),this.refreshBars_Active_Scale(),this.refreshResultPreview(),this.refreshBars_Item_Count()},fixIntervalFilterRange:function(){"log"===this.options.intervalScale||"step"===this.options.intervalScale?(this.intervalFilter.active.min=Math.round(this.intervalFilter.active.min),this.intervalFilter.active.max=Math.round(this.intervalFilter.active.max)):"time"===this.options.intervalScale||this.hasFloat||(this.intervalFilter.active.min=Math.round(this.intervalFilter.active.min),this.intervalFilter.active.max=Math.round(this.intervalFilter.active.max))},insertSlider:function(){var t=this;this.dom.intervalSlider.append("span").attr("class","base total").on("mousedown",function(){if(1===d3.event.which){t.dom.intervalSlider.attr("anim",!1);var i=this.parentNode,e=t.intervalScale.invert(d3.mouse(i)[0]);d3.select("body").style("cursor","ew-resize").on("mousemove",function(){var s=t.intervalScale.invert(d3.mouse(i)[0]);t.intervalFilter.active.min=d3.min([e,s]),t.intervalFilter.active.max=d3.max([e,s]),t.fixIntervalFilterRange(),t.refreshIntervalSlider(),this.timer&&(clearTimeout(this.timer),this.timer=null),this.timer=setTimeout(function(){t.isFiltered()?(t.intervalFilter.addFilter(!0),sendLog&&sendLog(kshf.LOG.FILTER_INTRVL_HANDLE,{id:t.intervalFilter.id,info:t.intervalFilter.active.min+"x"+t.intervalFilter.active.m})):t.intervalFilter.clearFilter(!0)},250)}).on("mouseup",function(){t.dom.intervalSlider.attr("anim",!0),d3.select("body").style("cursor","auto").on("mousemove",null).on("mouseup",null)}),d3.event.preventDefault()}}),this.dom.intervalSlider.append("span").attr("class","base active").each(function(){this.tipsy=new Tipsy(this,{gravity:"s",title:function(){return"Drag to filter"}})}).on("mouseout",function(){this.tipsy.hide()}).on("mousedown",function(){if(this.tipsy.hide(),1===d3.event.which&&"time"!==t.options.intervalScale){t.dom.intervalSlider.attr("anim",!1);var i=this.parentNode,e=t.intervalFilter.active.min,s=t.intervalFilter.active.max,a=s-e,r=t.intervalScale.invert(d3.mouse(i)[0]);d3.select("body").style("cursor","ew-resize").on("mousemove",function(){var n=t.intervalScale.invert(d3.mouse(i)[0]),o=n-r;t.intervalFilter.active.min=e+o,t.intervalFilter.active.max=s+o,t.intervalFilter.active.min<t.intervalRange.min&&(t.intervalFilter.active.min=t.intervalRange.min,t.intervalFilter.active.max=t.intervalRange.min+a),t.intervalFilter.active.max>t.intervalRange.max&&(t.intervalFilter.active.max=t.intervalRange.max,t.intervalFilter.active.min=t.intervalRange.max-a),t.fixIntervalFilterRange(),t.refreshIntervalSlider(),this.timer&&(clearTimeout(this.timer),this.timer=null),this.timer=setTimeout(function(){t.isFiltered()?(t.intervalFilter.addFilter(!0),sendLog&&sendLog(kshf.LOG.FILTER_INTRVL_HANDLE,{id:t.intervalFilter.id,info:t.intervalFilter.active.min+"x"+t.intervalFilter.active.max})):t.intervalFilter.clearFilter(!0)},200)}).on("mouseup",function(){t.dom.intervalSlider.attr("anim",!0),d3.select("body").style("cursor","auto").on("mousemove",null).on("mouseup",null)}),d3.event.preventDefault()}});var i=function(i){var e=this;if(1===d3.event.which){t.dom.intervalSlider.attr("anim",!1);var s=this.parentNode;d3.select("body").style("cursor","ew-resize").on("mousemove",function(){e.dragging=!0,t.browser.pauseResultPreview=!0;var a=t.intervalScale.invert(d3.mouse(s)[0]);if(t.intervalFilter.active[i]=a,t.intervalFilter.active.min>t.intervalFilter.active.max){var r=t.intervalFilter.active.min;t.intervalFilter.active.min=t.intervalFilter.active.max,t.intervalFilter.active.max=r,i="min"===i?"max":"min"}t.fixIntervalFilterRange(),t.refreshIntervalSlider(),this.timer&&(clearTimeout(this.timer),this.timer=null),this.timer=setTimeout(function(){t.isFiltered()?(sendLog&&sendLog(kshf.LOG.FILTER_INTRVL_HANDLE,{id:t.intervalFilter.id,info:t.intervalFilter.active.min+"x"+t.intervalFilter.active.max}),t.intervalFilter.addFilter(!0)):t.intervalFilter.clearFilter(!0)},200)}).on("mouseup",function(){e.dragging=!1,t.browser.pauseResultPreview=!1,t.dom.intervalSlider.attr("anim",!0),d3.select("body").style("cursor","auto").on("mousemove",null).on("mouseup",null)}),d3.event.preventDefault()}};this.dom.intervalSlider.selectAll("span.handle").data(["min","max"]).enter().append("span").attr("class",function(t){return"handle "+t}).each(function(){this.tipsy=new Tipsy(this,{gravity:"s",title:function(){return"Drag to filter"}})}).on("mouseover",function(){this.dragging!==!0&&this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}).on("mousedown",function(t,e){this.tipsy.hide(),i.call(this,t,e)}).append("span").attr("class","invalidArea"),this.dom.intervalSlider.append("div").attr("class","selectedItemValue").append("div").attr("class","circlee")},updateBarScale2Total:function(){this.barHeightScale=this.barHeightScale.domain([0,this.getMaxBinTotalItems()]).range([0,this.height_hist])},updateBarScale2Active:function(){this.barHeightScale=this.barHeightScale.domain([0,this.getMaxBinActiveItems()]).range([0,this.height_hist])},updateActiveItems:function(){this.histBins.forEach(function(t){t.itemCount_Active=0,t.forEach(function(i){i.isWanted&&(void 0!==i.resultDOM||0!==i.itemCount_Active)&&t.itemCount_Active++})})},insertAxisLabels:function(){var t=this,i=this.dom.labelGroup.selectAll("span.tick").data(this.intervalTicks),e=i.enter().append("span").attr("class","tick");i.exit().remove(),"step"!==this.options.intervalScale&&e.append("span").attr("class","line"),e.append("span").attr("class","text"),this.dom.labelTicks=this.dom.labelGroup.selectAll("span.tick"),this.dom.labelTicks.selectAll("span.text").text(function(i){return t.intervalTickFormat(i)}),this.refreshAxisLabelPos()},refreshAxisLabelPos:function(){var t=this,i="step"===this.options.intervalScale?this.barWidth/2:0;this.dom.labelTicks.style("left",function(e){return t.intervalScale(e)+i+"px"})},refreshBins_Translate:function(){var t=this,i="step"===this.options.intervalScale?this.barGap:0;kshf.Util.setTransform(this.dom.histogram_bins[0][0],"translateY("+t.barHeightScale.range()[1]+"px)"),this.dom.histogram_bin.each(function(e){kshf.Util.setTransform(this,"translateX("+(t.intervalScale(e.x)+i)+"px)")})},refreshBars_Total_Scale:function(){var t=this,i=this.barWidth-2*this.barGap;this.dom.bars_total.each(function(e){kshf.Util.setTransform(this,"scale("+i+","+t.barHeightScale(e.y)+")")})},refreshBars_Active_Scale:function(){var t=this,i=this.barWidth-2*this.barGap;this.dom.bars_active.each(function(e){kshf.Util.setTransform(this,"scale("+i+","+t.barHeightScale(e.itemCount_Active)+")")}),this.dom.bars_item_count.each(function(i){kshf.Util.setTransform(this,"translate("+t.barWidth/2+"px,"+-t.barHeightScale(i.itemCount_Active)+"px)")})},clearResultPreview:function(){if(!this.isEmpty&&!this.collapsed){var t=this.barWidth-2*this.barGap;this.dom.bars_highlight.each(function(i){i.itemCount_Preview=0,kshf.Util.setTransform(this,"scale("+t+",0)")})}},refreshResultPreview:function(){if(!this.isEmpty&&!this.collapsed){var t=this.barHeightScale,i=this.barWidth-2*this.barGap;this.dom.bars_highlight.each(function(e){0!==e.itemCount_Preview&&kshf.Util.setTransform(this,"scale("+i+","+t(e.itemCount_Preview)+")")})}},refreshBars_Item_Count:function(){this.dom.histogram_bin.attr("noitem",function(t){return 0===t.itemCount_Active});var t=kshf.Util.formatForItemCount;this.dom.bars_item_count.text(function(i){return t(i.itemCount_Active)})},refreshIntervalSlider:function(){var t=this,i=this.intervalScale(this.intervalFilter.active.min),e=this.intervalScale(this.intervalFilter.active.max);t.intervalFilter.active.min===t.intervalRange.min&&(i=t.intervalScale.range()[0]),t.intervalFilter.active.max===t.intervalRange.max&&(e=t.intervalScale.range()[1]),this.dom.intervalSlider.select(".base.total").style("width",this.intervalScale.range()[1]+"px"),this.dom.intervalSlider.select(".base.active").attr("filtered",this.isFiltered()).each(function(){kshf.Util.setTransform(this,"translate("+i+"px,0) scale("+(e-i)+",1)")}),this.dom.intervalSlider.selectAll(".handle").each(function(t){kshf.Util.setTransform(this,"translate("+("min"===t?i:e)+"px,0)")})},refreshWidth:function(){var t=this.getWidth();this.dom.facetInterval.style("width",t+"px"),this.updateIntervalWidth(t-2*this.histogramMargin)},getMaxTotalItemsPerRow:function(){if(!this._maxTotalItemsPerRow){var t=this._dataMap;this._maxTotalItemsPerRow=d3.max(this.getAttribs(),function(i){return null===t(i)?null:i.items.length})}return this._maxTotalItemsPerRow},setHeight:function(t){var i=t-this.getHeight_Header()-this.getHeight_Extra();this.height_hist!==i&&(this.height_hist=i,this.updateBarScale2Active(),this.refreshBins_Translate(),this.refreshBars_Active_Scale(),this.refreshBars_Total_Scale(),this.refreshResultPreview(),this.refreshHeight())},refreshHeight:function(){this.dom.histogram.style("height",this.height_hist+15+"px"),this.dom.wrapper.style("height",(this.collapsed?"0":this.height_hist+this.getHeight_Extra())+"px")},setCollapsed:function(t){this.collapsed=t,this.divRoot.attr("collapsed",this.collapsed===!1?"false":"true"),t===!1&&this.clearResultPreview()},collapseFacet:function(t){this.setCollapsed(t),this.browser.updateLayout_Height(),sendLog&&sendLog(t===!0?kshf.LOG.FACET_COLLAPSE:kshf.LOG.FACET_SHOW,{id:this.id})},updateAfterFilter:function(t){this.isEmpty||(this.updateActiveItems(),this.refreshBars_Item_Count(),this.animateBarScale2Active(),this.options.showPercentile&&this.updateQuantiles())},animateBarScale2Active:function(){var t=this;this.updateBarScale2Active(),this.refreshBins_Translate(),this.refreshBars_Active_Scale(),this.refreshBars_Total_Scale(),this.dom.bars_highlight.attr("fast",null),this.refreshResultPreview(),setTimeout(function(){t.dom.bars_highlight.attr("fast",!0)},700)},setSelectedPosition:function(t){void 0!==this.intervalScale&&this.dom.selectedItemValue.style("left",this.intervalScale(t)+"px").style("display","block")},hideSelectedPosition:function(){this.dom.selectedItemValue.style("display",null)},updateQuantiles:function(){var t=[],i=this.intervalFilter.id,e=function(t){return t.mappedDataCache[i].v};this.filteredItems=this.filteredItems.filter(function(t){var i=e(t);return null===i?!1:void 0===i?!1:!0}),this.filteredItems.forEach(function(i){i.isWanted&&t.push(e(i))}),this.quantile_val={},this.quantile_pos={},[10,20,30,40,50,60,70,80,90].forEach(function(i){this.quantile_val[i]=d3.quantile(t,i/100),this.quantile_pos[i]=this.intervalScale(this.quantile_val[i]),kshf.Util.setTransform(this.dom.quantile[i][0][0],"translateX("+this.quantile_pos[i]+"px)")},this),[[10,90],[20,80],[30,70],[40,60]].forEach(function(t){kshf.Util.setTransform(this.dom.quantile[""+t[0]+"_"+t[1]][0][0],"translateX("+this.quantile_pos[t[0]]+"px) "+"scaleX("+(this.quantile_pos[t[1]]-this.quantile_pos[t[0]])+") ")},this)}};